{
  "firestoreArchitecture": {
    "description": "MyBazaar 慈善义卖管理系统 - Firestore 数据架构（完全正确版）",
    "version": "2025-11-28-v2",
    "lastUpdated": "2025-11-28",
    "architectureChanges": {
      "version_2025-11-28-v2": [
        "修正 Event 集合路径：从顶级集合改为 Organization 的子集合",
        "修正所有子集合路径：users, pointAllocations, departmentStats 等都在 Event 下",
        "完整路径示例：organizations/{orgId}/events/{eventId}/users/{userId}",
        "添加 admin_uids 集合，明确 Platform Admin 存储位置",
        "Organization 集合：删除 adminUsers 字段，添加 contact 联系人信息",
        "Event.eventManager：从 admins 数组改为单个对象，包含详细信息和登录密码",
        "删除 GlobalUsers 集合，简化架构（用户只参与单个 Event）",
        "明确三层权限架构：Platform Admin -> Organization -> Event (Event Manager)"
      ]
    },
    "keyArchitecturePrinciples": {
      "hierarchicalStructure": "organizations/{orgId}/events/{eventId}/users/{userId}",
      "dataIsolation": "每个 Organization 的数据完全隔离",
      "eventManager": "每个 Event 只有一个 Event Manager，存储在 Event.eventManager 对象中",
      "subcollections": "users, pointAllocations, departmentStats 等都是 Event 的子集合"
    },
    "collections": {
      "admin_uids": {
        "path": "admin_uids/{adminUid}",
        "description": "平台管理员（Platform Admin）信息",
        "level": "Platform",
        "documentStructure": {
          "adminUid": "string (Platform Admin的认证UID，文档ID)",
          "email": "string (邮箱)",
          "phoneNumber": "string (电话号码)",
          "displayName": "string (显示名称，可选)",
          "role": "string (固定值：'platformAdmin')",
          "isActive": "boolean (是否激活)",
          "permissions": "array (权限列表，可选)",
          "createdAt": "timestamp (创建时间)",
          "lastLoginAt": "timestamp (最后登录时间)"
        },
        "indexes": [
          "email",
          "isActive"
        ],
        "securityRules": "只有已认证的Platform Admin可以读取；创建和修改需要超级管理员权限"
      },
      "organizations": {
        "path": "organizations/{organizationId}",
        "description": "组织（学校）基本信息",
        "level": "Organization",
        "documentStructure": {
          "organizationId": "string (自动生成的文档ID)",
          "orgCode": "string (组织代码，如 'chhs')",
          "orgName": {
            "zh-CN": "string (中文名称)",
            "en-US": "string (英文名称，可选)"
          },
          "orgType": "string ('school' | 'community' | 'company')",
          "address": {
            "street": "string",
            "city": "string",
            "state": "string",
            "postcode": "string",
            "country": "string (默认 'Malaysia')"
          },
          "contactInfo": {
            "phone": "string (机构电话)",
            "email": "string (机构邮箱)",
            "website": "string (可选)"
          },
          "contact": {
            "name": "string (联系人姓名)",
            "phone": "string (联系电话)",
            "email": "string (联系邮箱)",
            "position": "string (职位，如'校长'、'主任')"
          },
          "identityTags": [
            {
              "id": "string (标签ID，如 'student')",
              "name": {
                "zh-CN": "string (中文名，如 '学生')",
                "en-US": "string (英文名，如 'Student')"
              },
              "isActive": "boolean (是否激活)",
              "displayOrder": "number (显示顺序)"
            }
          ],
          "departments": [
            {
              "id": "string (部门ID，如 'J1A')",
              "name": "string (部门名称，如 '一年级A班')",
              "isActive": "boolean (是否激活)",
              "userCount": "number (部门用户数)",
              "displayOrder": "number (显示顺序)",
              "createdBy": "string ('system' | 'manual')",
              "createdAt": "timestamp"
            }
          ],
          "settings": {
            "defaultLanguage": "string (默认 'zh-CN')",
            "timezone": "string (默认 'Asia/Kuala_Lumpur')",
            "currency": "string (默认 'MYR')"
          },
          "statistics": {
            "totalEvents": "number (总活动数)",
            "activeEvents": "number (进行中活动数)",
            "totalUsers": "number (总用户数)",
            "lastUpdated": "timestamp"
          },
          "status": "string ('active' | 'inactive' | 'suspended')",
          "createdAt": "timestamp",
          "updatedAt": "timestamp",
          "createdBy": "string (Platform Admin UID)"
        },
        "indexes": [
          "orgCode",
          "status"
        ],
        "securityRules": "只有 Platform Admin 可以创建/修改组织信息",
        "subcollections": {
          "events": {
            "path": "organizations/{organizationId}/events/{eventId}",
            "description": "义卖活动信息（Organization 的子集合）",
            "level": "Event",
            "documentStructure": {
              "eventId": "string (自动生成的文档ID)",
              "eventCode": "string (活动代码，如 'ban')",
              "orgCode": "string (组织代码，冗余字段用于查询)",
              "eventName": {
                "zh-CN": "string (中文名称)",
                "en-US": "string (英文名称，可选)"
              },
              "eventInfo": {
                "description": "string (活动描述)",
                "fairDate": "timestamp (市集日期)",
                "consumptionPeriod": {
                  "startDate": "timestamp (消费开始日期)",
                  "endDate": "timestamp (消费结束日期)"
                }
              },
              "eventManager": {
                "description": "Event Manager 详细信息（单个对象，每个 Event 只有一个）",
                "authUid": "string (Event Manager的认证UID)",
                "displayName": "string (显示名称)",
                "chineseName": "string (中文名)",
                "englishName": "string (英文名)",
                "email": "string (邮箱，可选)",
                "phoneNumber": "string (电话号码)",
                "password": "string (登录密码，加密存储)",
                "passwordSalt": "string (密码盐值)",
                "addedAt": "timestamp (添加时间)",
                "addedBy": "string (添加者的Platform Admin UID)"
              },
              "pointAllocationRules": {
                "description": "点数分配规则配置",
                "sellerManager": {
                  "maxPerAllocation": "number (每次给单个用户最多分配的点数，如 100)",
                  "enableWarnings": "boolean (是否启用收款警示)",
                  "warningThreshold": "number (待收款警示阈值，如 0.3 表示30%)"
                }
              },
              "globalPointsStats": {
                "description": "全局点数统计（实时维护）",
                "totalAllocated": "number (累计分配的点数总额)",
                "currentCirculation": "number (当前流通中的点数)",
                "totalSold": "number (累计售出点数)",
                "totalRevenue": "number (累计销售额 RM，1:1比例)",
                "totalCollected": "number (累计已收款项 RM)",
                "pendingCollection": "number (待收款项 RM)",
                "collectionRate": "number (收款率，0-1之间)",
                "lastUpdated": "timestamp",
                "lastCalculated": "timestamp (上次完整计算时间)"
              },
              "roleStats": {
                "description": "各角色统计信息",
                "eventManagers": {
                  "count": "number (Event Manager 数量，固定为1)",
                  "totalAllocations": "number (累计分配次数)",
                  "totalPointsAllocated": "number (累计分配点数)"
                },
                "sellerManagers": {
                  "count": "number (Seller Manager 数量)",
                  "totalAllocations": "number (累计分配次数)",
                  "totalPointsAllocated": "number (累计分配点数)",
                  "averageCollectionRate": "number (平均收款率)"
                },
                "sellers": {
                  "count": "number (Seller 总数)",
                  "activeCount": "number (有交易记录的 Seller 数)",
                  "totalRevenue": "number (累计销售额)"
                },
                "merchants": {
                  "count": "number (Merchant 总数)",
                  "activeCount": "number (有交易记录的 Merchant 数)",
                  "totalRevenue": "number (累计销售额)"
                },
                "customers": {
                  "count": "number (Customer 总数)",
                  "activeCount": "number (有交易记录的 Customer 数)",
                  "totalSpent": "number (累计消费额)"
                }
              },
              "departmentOverview": {
                "description": "部门概览统计",
                "totalDepartments": "number (部门总数)",
                "topPerformers": [
                  {
                    "departmentCode": "string",
                    "departmentName": "string",
                    "totalRevenue": "number",
                    "collectionRate": "number"
                  }
                ],
                "lowestCollectionRate": {
                  "departmentCode": "string",
                  "departmentName": "string",
                  "collectionRate": "number"
                }
              },
              "statistics": {
                "totalUsers": "number (总用户数)",
                "totalManagers": "number (管理员总数)",
                "totalSellers": "number (Seller 总数)",
                "totalMerchants": "number (Merchant 总数)",
                "totalCustomers": "number (Customer 总数)",
                "lastUpdated": "timestamp"
              },
              "status": "string ('planning' | 'active' | 'completed' | 'cancelled')",
              "createdAt": "timestamp",
              "updatedAt": "timestamp",
              "createdBy": "string (Platform Admin UID)"
            },
            "indexes": [
              "orgCode",
              "eventCode",
              "status",
              "eventInfo.fairDate"
            ],
            "securityRules": "Platform Admin 可以创建活动；Event Manager 可以管理活动内容",
            "subcollections": {
              "users": {
                "path": "organizations/{organizationId}/events/{eventId}/users/{userId}",
                "description": "活动参与者信息（Event 的子集合）",
                "documentStructure": {
                  "userId": "string (Firebase Auth UID，文档ID)",
                  "authUid": "string (认证UID，与userId相同)",
                  "roles": [
                    "string ( 'sellerManager' | 'merchantManager' | 'customerManager' | 'financeManager' | 'seller' | 'merchant' | 'customer')"
                  ],
                  "identityTag": "string ('student' | 'teacher' | 'parent' | 'staff' | 'volunteer' | 'external')",
                  "identityInfo": {
                    "identityId": "string (身份编号，如学号、工号)",
                    "identityTag": "string (身份标签)",
                    "identityName": "string (身份名称)",
                    "department": "string (部门代码)"
                  },
                  "basicInfo": {
                    "phoneNumber": "string (电话号码)",
                    "englishName": "string (英文名)",
                    "chineseName": "string (中文名)",
                    "email": "string (邮箱，可选)",
                    "passwordHash": "string (密码哈希)",
                    "passwordSalt": "string (密码盐值)",
                    "isPhoneVerified": "boolean (电话是否验证)"
                  },
                  "pointsStats": {
                    "description": "点数统计（实时维护，主要用于 seller 角色）",
                    "totalReceived": "number (累计收到的点数)",
                    "currentBalance": "number (当前拥有点数/库存)",
                    "totalSold": "number (累计已售出点数)",
                    "totalRevenue": "number (累计销售额 RM)",
                    "totalCollected": "number (累计已收款 RM)",
                    "pendingCollection": "number (待收款 RM)",
                    "collectionRate": "number (个人收款率，0-1之间)",
                    "receivedFromEventManager": "number (从 Event Manager 获得的点数)",
                    "receivedFromSellerManager": "number (从 Seller Manager 获得的点数)",
                    "lastReceived": "timestamp (最后一次收到点数)",
                    "lastSold": "timestamp (最后一次销售)",
                    "lastCollected": "timestamp (最后一次收款)",
                    "lastUpdated": "timestamp"
                  },
                  "seller": {
                    "description": "Seller 角色专用数据",
                    "availablePoints": "number (可用点数余额)",
                    "totalPointsSold": "number (累计售出点数)",
                    "totalRevenue": "number (累计销售额)",
                    "totalCollected": "number (累计已收款)",
                    "pendingCollection": "number (待收款)",
                    "collectionRate": "number (收款率)",
                    "collectionAlert": "boolean (是否有收款警示)",
                    "lastTransactionAt": "timestamp",
                    "transactions": {
                      "description": "点数分配/扣减交易记录，以时间戳为键的 Map 对象。记录来自 Event Manager 批量分配或 Seller Manager 的部门内分配",
                      "<timestamp_key>": {
                        "amount": "number",
                        "type": "allocation | deduction",
                        "allocatedBy": "eventManager | sellerManager",
                        "note": "string",
                        "timestamp": "timestamp"
                      }
                    },
                    "merchant": {
                      "description": "Merchant 角色专用数据",
                      "totalPointsSold": "number",
                      "totalRevenue": "number",
                      "totalCollected": "number",
                      "pendingCollection": "number",
                      "collectionRate": "number",
                      "collectionAlert": "boolean",
                      "lastTransactionAt": "timestamp"
                    },
                    "customer": {
                      "description": "Customer 角色专用数据",
                      "availablePoints": "number (可用点数余额)",
                      "totalSpent": "number (累计消费点数)",
                      "lastPurchaseAt": "timestamp"
                    },
                    "sellerManager": {
                      "description": "Seller Manager 角色专用数据",
                      "totalAllocations": "number (累计分配次数)",
                      "totalPointsAllocated": "number (累计分配点数)",
                      "managedDepartments": [
                        "string (管理的部门代码)"
                      ],
                      "alerts": {
                        "lowCollectionRate": [
                          "string (低收款率警示的用户ID列表)"
                        ]
                      },
                      "lastAllocationAt": "timestamp"
                    },
                    "accountStatus": {
                      "isActive": "boolean (账户是否激活)",
                      "isSuspended": "boolean (是否被暂停)",
                      "suspensionReason": "string (暂停原因，可选)",
                      "lastLoginAt": "timestamp"
                    },
                    "activityData": {
                      "lastActiveAt": "timestamp",
                      "totalLogins": "number",
                      "createdAt": "timestamp",
                      "updatedAt": "timestamp",
                      "createdBy": "string (创建者UID)"
                    }
                  },
                  "indexes": [
                    "roles",
                    "identityTag",
                    "identityInfo.department",
                    "accountStatus.isActive"
                  ],
                  "securityRules": "用户可以读取自己的数据；Event Manager 可以读取所有用户；Seller Manager 可以读取 managedDepartments 内的用户",
                  "subcollections": {
                    "pointAllocations": {
                      "path": "organizations/{organizationId}/events/{eventId}/users/{sellerManagerId}/pointAllocations/{allocationId}",
                      "description": "Seller Manager 的点数分配记录（仅 sellerManager 角色有此子集合）",
                      "documentStructure": {
                        "allocationId": "string (分配记录ID)",
                        "fromUserId": "string (Seller Manager的userId)",
                        "toUserId": "string (接收者的userId)",
                        "toDepartment": "string (接收者的部门)",
                        "points": "number (分配的点数)",
                        "reason": "string (分配原因，可选)",
                        "allocatedAt": "timestamp",
                        "status": "string ('completed' | 'cancelled')"
                      },
                      "indexes": [
                        "toUserId",
                        "allocatedAt"
                      ]
                    }
                  }
                },
                "pointAllocations": {
                  "path": "organizations/{organizationId}/events/{eventId}/pointAllocations/{allocationId}",
                  "description": "Event Manager 的点数分配记录（Event 级别）",
                  "documentStructure": {
                    "allocationId": "string (分配记录ID)",
                    "fromUserId": "string (Event Manager的userId)",
                    "toUserId": "string (接收者的userId，可以是 Seller 或 Seller Manager)",
                    "toRole": "string (接收者角色：'seller' | 'sellerManager')",
                    "toDepartment": "string (接收者的部门)",
                    "points": "number (分配的点数)",
                    "reason": "string (分配原因，可选)",
                    "allocatedAt": "timestamp",
                    "allocatedBy": "string (Event Manager UID)",
                    "status": "string ('completed' | 'cancelled')"
                  },
                  "indexes": [
                    "toUserId",
                    "allocatedAt",
                    "status"
                  ]
                },
                "departmentStats": {
                  "path": "organizations/{organizationId}/events/{eventId}/departmentStats/{departmentCode}",
                  "description": "部门统计信息（按部门聚合）",
                  "documentStructure": {
                    "departmentCode": "string (部门代码)",
                    "departmentName": "string (部门名称)",
                    "totalUsers": "number (部门总用户数)",
                    "totalSellers": "number (Seller 数量)",
                    "activeSellers": "number (有交易的 Seller 数)",
                    "pointsStats": {
                      "totalReceived": "number (部门累计收到点数)",
                      "currentBalance": "number (部门当前点数余额)",
                      "totalSold": "number (部门累计售出点数)",
                      "totalRevenue": "number (部门累计销售额 RM)",
                      "totalCollected": "number (部门累计已收款 RM)",
                      "pendingCollection": "number (部门待收款 RM)",
                      "collectionRate": "number (部门收款率，0-1之间)"
                    },
                    "collectionAlerts": {
                      "count": "number (有收款警示的用户数)",
                      "userIds": [
                        "string (有警示的用户ID列表)"
                      ]
                    },
                    "topPerformers": [
                      {
                        "userId": "string",
                        "displayName": "string",
                        "totalRevenue": "number",
                        "collectionRate": "number"
                      }
                    ],
                    "lastUpdated": "timestamp",
                    "lastCalculated": "timestamp"
                  },
                  "indexes": [
                    "departmentCode",
                    "pointsStats.totalRevenue"
                  ]
                },
                "sellerManagerStats": {
                  "path": "organizations/{organizationId}/events/{eventId}/sellerManagerStats/{sellerManagerId}",
                  "description": "Seller Manager 的统计信息（managedDepartments 存储在 users/{userId}/roleSpecificData/sellerManager 中）",
                  "documentStructure": {
                    "sellerManagerId": "string (Seller Manager的userId)",
                    "displayName": "string",
                    "managedUsersCount": "number (管理的用户总数)",
                    "totalAllocations": "number (累计分配次数)",
                    "totalPointsAllocated": "number (累计分配点数)",
                    "managedPointsStats": {
                      "description": "管理范围内的点数统计",
                      "totalReceived": "number (管理范围内用户累计收到点数)",
                      "currentBalance": "number (管理范围内用户当前点数余额)",
                      "totalSold": "number (管理范围内用户累计售出点数)",
                      "totalRevenue": "number (管理范围内累计销售额)",
                      "totalCollected": "number (管理范围内累计已收款)",
                      "pendingCollection": "number (管理范围内待收款)",
                      "collectionRate": "number (管理范围内收款率)"
                    },
                    "alerts": {
                      "lowCollectionRateCount": "number (低收款率警示用户数)",
                      "lowCollectionRateUsers": [
                        {
                          "userId": "string",
                          "displayName": "string",
                          "department": "string",
                          "collectionRate": "number",
                          "pendingCollection": "number"
                        }
                      ]
                    },
                    "departmentBreakdown": [
                      {
                        "departmentCode": "string",
                        "departmentName": "string",
                        "userCount": "number",
                        "totalRevenue": "number",
                        "collectionRate": "number"
                      }
                    ],
                    "lastUpdated": "timestamp",
                    "lastCalculated": "timestamp"
                  },
                  "indexes": [
                    "sellerManagerId"
                  ]
                },
                "transactions": {
                  "path": "organizations/{organizationId}/events/{eventId}/transactions/{transactionId}",
                  "description": "交易记录（Seller/Merchant 售出点数给 Customer）",
                  "documentStructure": {
                    "transactionId": "string (交易ID)",
                    "type": "string ('sale' | 'refund')",
                    "sellerId": "string (卖家userId，Seller或Merchant)",
                    "sellerRole": "string ('seller' | 'merchant')",
                    "sellerName": "string (卖家名称)",
                    "sellerDepartment": "string (卖家部门)",
                    "customerId": "string (买家userId)",
                    "customerName": "string (买家名称)",
                    "points": "number (交易点数)",
                    "amount": "number (交易金额 RM，1:1比例)",
                    "collectionStatus": "string ('collected' | 'pending')",
                    "collectedAmount": "number (已收款金额)",
                    "collectedAt": "timestamp (收款时间，可选)",
                    "transactionAt": "timestamp (交易时间)",
                    "remarks": "string (备注，可选)"
                  },
                  "indexes": [
                    "sellerId",
                    "customerId",
                    "transactionAt",
                    "collectionStatus"
                  ]
                },
                "departments": {
                  "path": "organizations/{organizationId}/events/{eventId}/departments/{departmentCode}",
                  "description": "活动中的部门元数据（与 Organization.departments 同步，但允许Event级别的自定义）",
                  "documentStructure": {
                    "departmentCode": "string (部门代码)",
                    "departmentName": "string (部门名称)",
                    "isActive": "boolean (是否激活)",
                    "userCount": "number (该部门的用户数)",
                    "createdBy": "string ('system' | 'manual')",
                    "createdAt": "timestamp",
                    "updatedAt": "timestamp"
                  },
                  "indexes": [
                    "departmentCode",
                    "isActive"
                  ]
                }
              }
            }
          }
        },
        "otp_sessions": {
          "path": "otp_sessions/{sessionId}",
          "description": "OTP 验证会话（临时数据，用于登录验证）",
          "level": "Platform",
          "documentStructure": {
            "sessionId": "string (会话ID)",
            "phoneNumber": "string (手机号)",
            "orgCode": "string (组织代码)",
            "eventCode": "string (活动代码)",
            "otpCodeHash": "string (OTP哈希值)",
            "expiresAt": "number (过期时间戳)",
            "attempts": "number (尝试次数)",
            "createdAt": "timestamp",
            "devMode": "boolean (是否为开发模式)"
          },
          "indexes": [
            "phoneNumber",
            "expiresAt"
          ],
          "securityRules": "只读；由 Cloud Functions 创建和管理"
        }
      },
      "cloudFunctions": {
        "description": "Cloud Functions 触发器设计",
        "functions": {
          "updateUserPointsStats": {
            "trigger": "organizations/{orgId}/events/{eventId}/users/{userId} onWrite",
            "description": "当用户点数变化时，更新相关统计",
            "tasks": [
              "计算用户的 pointsStats",
              "更新部门的 departmentStats",
              "更新 Event 的 globalPointsStats",
              "更新 SellerManager 的 sellerManagerStats（如果用户属于被管理范围）",
              "检查是否需要触发收款警示"
            ]
          },
          "onPointAllocation": {
            "trigger": "organizations/{orgId}/events/{eventId}/pointAllocations/{allocationId} onCreate",
            "description": "当 Event Manager 分配点数时",
            "tasks": [
              "更新接收者的 pointsStats.totalReceived",
              "更新接收者的 pointsStats.receivedFromEventManager",
              "更新部门的 departmentStats",
              "更新 Event 的 globalPointsStats",
              "更新 Event 的 roleStats.eventManagers"
            ]
          },
          "onSellerManagerAllocation": {
            "trigger": "organizations/{orgId}/events/{eventId}/users/{sellerManagerId}/pointAllocations/{allocationId} onCreate",
            "description": "当 Seller Manager 分配点数时",
            "tasks": [
              "验证分配额度是否超出 maxPerAllocation 限制",
              "更新接收者的 pointsStats.totalReceived",
              "更新接收者的 pointsStats.receivedFromSellerManager",
              "更新部门的 departmentStats",
              "更新 SellerManager 的 sellerManagerStats",
              "更新 Event 的 globalPointsStats",
              "计算并更新收款警示"
            ]
          },
          "onTransaction": {
            "trigger": "organizations/{orgId}/events/{eventId}/transactions/{transactionId} onWrite",
            "description": "当交易发生时，更新统计",
            "tasks": [
              "更新 Seller 的 pointsStats（售出、收款等）",
              "更新部门的 departmentStats",
              "更新 Event 的 globalPointsStats",
              "检查收款警示"
            ]
          },
          "dailyStatsRecalculation": {
            "trigger": "PubSub Schedule (每天凌晨2点)",
            "description": "定时重算所有统计数据，确保一致性",
            "tasks": [
              "遍历所有 Organization 的所有 Event",
              "重新计算 globalPointsStats",
              "重新计算所有 departmentStats",
              "重新计算所有 sellerManagerStats",
              "标记 lastCalculated 时间戳"
            ]
          },
          "checkCollectionWarnings": {
            "trigger": "organizations/{orgId}/events/{eventId}/users/{userId} onUpdate",
            "description": "检查并更新收款警示",
            "tasks": [
              "计算待收款比例",
              "根据 Event.pointAllocationRules.sellerManager.warningThreshold 判断",
              "更新用户的 collectionAlert",
              "更新部门的 collectionAlerts",
              "更新 SellerManager 的 alerts"
            ]
          }
        }
      },
      "securityRules": {
        "description": "Firestore Security Rules 概览",
        "principles": [
          "三层权限架构：Platform Admin（平台级）-> Organization（组织级）-> Event（活动级，由 Event Manager 管理）",
          "Platform Admin 权限：可以创建和管理所有 Organization；可以创建 Event 并指定 Event Manager",
          "Event Manager 权限：每个 Event 只有一个 Event Manager；只能管理自己负责的 Event 内的数据",
          "完全数据隔离：不同 Organization 和 Event 之间的数据完全隔离",
          "角色权限：基于用户角色（Platform Admin, Event Manager, Seller Manager, Seller, Merchant, Customer, Finance）控制访问",
          "所有权验证：用户只能访问自己的数据或管理范围内的数据",
          "Seller Manager 权限：只能管理 managedDepartments 内的用户数据",
          "统计数据保护：统计文档只能由系统（Cloud Functions）写入，用户只读"
        ],
        "ruleExamples": {
          "admin_uids": {
            "read": "已认证的 Platform Admin 可读",
            "write": "仅超级管理员权限（通过 Cloud Functions）"
          },
          "organizations": {
            "read": "Platform Admin 可以读取所有组织；Event Manager 可以读取自己所在组织",
            "write": "仅 Platform Admin 可以创建和修改组织信息"
          },
          "organizations/{orgId}/events": {
            "read": "Platform Admin 和对应的 Event Manager 可读",
            "write": "Platform Admin 可以创建 Event；Event Manager 可以修改自己管理的 Event"
          },
          "organizations/{orgId}/events/{eventId}/users": {
            "read": "用户可以读取自己的数据；Event Manager 可以读取所有用户；Seller Manager 可以读取 managedDepartments 内的用户",
            "write": "用户只能更新自己的基本信息；Event Manager 可以创建/更新用户；Seller Manager 可以更新管理范围内的用户"
          },
          "organizations/{orgId}/events/{eventId}/departmentStats": {
            "read": "Event Manager 和相关 Seller Manager 可读",
            "write": "仅 Cloud Functions 可写"
          },
          "organizations/{orgId}/events/{eventId}/transactions": {
            "read": "交易双方和 Event Manager 可读",
            "write": "Seller/Merchant 可以创建交易；Event Manager 可以修改交易"
          }
        }
      },
      "dataFlowExamples": {
        "eventManagerAllocatesPoints": {
          "description": "Event Manager 分配点数给 Seller",
          "steps": [
            "1. Event Manager 在 frontend 输入分配信息（toUserId, points）",
            "2. Frontend 调用 Cloud Function: allocatePoints",
            "3. Cloud Function 验证权限（检查 Event.eventManager.authUid）",
            "4. Cloud Function 创建文档：organizations/{orgId}/events/{eventId}/pointAllocations/{allocationId}",
            "5. Firestore 触发器：onPointAllocation",
            "6. 更新 organizations/{orgId}/events/{eventId}/users/{toUserId}.pointsStats",
            "7. 更新 organizations/{orgId}/events/{eventId}/departmentStats/{deptCode}",
            "8. 更新 organizations/{orgId}/events/{eventId}.globalPointsStats"
          ]
        },
        "sellerManagerAllocatesPoints": {
          "description": "Seller Manager 分配点数给部门内的 Seller",
          "steps": [
            "1. Seller Manager 在 frontend 输入分配信息",
            "2. Frontend 调用 Cloud Function: allocatePointsBySellerManager",
            "3. Cloud Function 验证权限（检查 managedDepartments）",
            "4. Cloud Function 检查限额（pointAllocationRules.sellerManager.maxPerAllocation）",
            "5. Cloud Function 创建文档：organizations/{orgId}/events/{eventId}/users/{sellerManagerId}/pointAllocations/{allocationId}",
            "6. Firestore 触发器：onSellerManagerAllocation",
            "7. 更新接收者的 pointsStats",
            "8. 更新 departmentStats",
            "9. 更新 sellerManagerStats",
            "10. 检查收款警示"
          ]
        },
        "sellerSellsToCustomer": {
          "description": "Seller 售出点数给 Customer",
          "steps": [
            "1. Seller 在 frontend 扫描 Customer 二维码，输入点数",
            "2. Frontend 调用 Cloud Function: createTransaction",
            "3. Cloud Function 验证：Seller 有足够的点数余额（currentBalance）",
            "4. Cloud Function 创建交易：organizations/{orgId}/events/{eventId}/transactions/{transactionId}",
            "5. Firestore 触发器：onTransaction",
            "6. 更新 Seller 的 pointsStats（减少 currentBalance，增加 totalSold）",
            "7. 更新 Customer 的 customer.availablePoints（增加）",
            "8. 更新 departmentStats",
            "9. 更新 Event.globalPointsStats"
          ]
        }
      },
      "pathSummary": {
        "description": "完整路径参考",
        "topLevelCollections": [
          "admin_uids/{adminUid}",
          "organizations/{organizationId}",
          "otp_sessions/{sessionId}"
        ],
        "organizationSubcollections": [
          "organizations/{organizationId}/events/{eventId}"
        ],
        "eventSubcollections": [
          "organizations/{organizationId}/events/{eventId}/users/{userId}",
          "organizations/{organizationId}/events/{eventId}/pointAllocations/{allocationId}",
          "organizations/{organizationId}/events/{eventId}/departmentStats/{departmentCode}",
          "organizations/{organizationId}/events/{eventId}/sellerManagerStats/{sellerManagerId}",
          "organizations/{organizationId}/events/{eventId}/transactions/{transactionId}",
          "organizations/{organizationId}/events/{eventId}/departments/{departmentCode}"
        ],
        "userSubcollections": [
          "organizations/{organizationId}/events/{eventId}/users/{sellerManagerId}/pointAllocations/{allocationId}"
        ]
      }
    }
  }