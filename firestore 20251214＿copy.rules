rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================================
    // 辅助函数 (Helper Functions)
    // ============================================================================
    
    /**
     * 检查用户是否已认证
     */
    function isAuthenticated() {
      return request.auth != null;
    }
    
    /**
     * 检查用户是否是文档所有者
     */
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    /**
     * ✨ 检查用户是否有特定角色（从 Custom Claims 读取）
     */
    function hasRole(role) {
      return isAuthenticated() && 
             request.auth.token.roles != null &&
             role in request.auth.token.roles;
    }

    /**
     * ✨ 检查用户是否有任意一个角色（从 Custom Claims 读取）
     */
    function hasAnyRole(roles) {
      return isAuthenticated() && 
             request.auth.token.roles != null &&
             request.auth.token.roles.hasAny(roles);
    }
    
    /**
     * ✨ 检查 Custom Claims 中的 organizationId 和 eventId 是否匹配
     */
    function isInContext(orgId, eventId) {
      return isAuthenticated() &&
             request.auth.token.organizationId == orgId &&
             request.auth.token.eventId == eventId;
    }
    
    /**
     * ✅ 检查用户是否是 Event Manager（从 Custom Claims 读取）
     * 新架构：Event Manager 存储在 users 集合中，通过 roles=['eventManager'] 识别
     */
    function isEventManager(orgId, eventId) {
      return isInContext(orgId, eventId) && hasRole('eventManager');
    }
    
    /**
     * ✨ 检查用户是否是 Seller Manager（从 Custom Claims 读取）
     */
    function isSellerManager(orgId, eventId) {
      return isInContext(orgId, eventId) && hasRole('sellerManager');
    }
    
    /**
     * ✨ 检查用户是否是 Finance Manager（从 Custom Claims 读取）
     */
    function isFinanceManager(orgId, eventId) {
      return isInContext(orgId, eventId) && hasRole('financeManager');
    }
    
    /**
     * ✨ 检查用户是否管理特定部门（从 Custom Claims 读取）
     */
    function managesDepartment(orgId, eventId, departmentCode) {
      return isAuthenticated() && 
             isInContext(orgId, eventId) &&
             hasRole('sellerManager') &&
             request.auth.token.managedDepartments != null &&
             departmentCode in request.auth.token.managedDepartments;
    }
    
    /**
     * 检查用户是否被特定 Seller Manager 管理
     */
    function isManagedBy(orgId, eventId, sellerId, managerId) {
      let seller = get(/databases/$(database)/documents/organizations/$(orgId)/events/$(eventId)/users/$(sellerId)).data;
      return seller.managedBy.hasAny([managerId]);
    }
    
    /**
     * 检查是否只更新状态字段
     */
    function onlyStatusChange() {
      let affectedKeys = request.resource.data.diff(resource.data).affectedKeys();
      return affectedKeys.hasOnly(['status', 'updatedAt', 'verifiedAt', 'verifiedBy']);
    }
    
    /**
     * 检查是否只更新允许的字段
     */
    function onlyAllowedFields(allowedFields) {
      let affectedKeys = request.resource.data.diff(resource.data).affectedKeys();
      return affectedKeys.hasOnly(allowedFields);
    }
    
    // ============================================================================
    // Platform Admin (平台管理员)
    // ============================================================================
    function isPlatformAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/admin_uids/$(request.auth.uid));
    }

    match /admin_uids/{adminUid} {
      // Platform Admin 可以读取自己的信息
      allow read: if isOwner(adminUid);
      
      // 创建和修改需要超级管理员权限（通过 Cloud Functions）
      allow write: if false;
    }
    
    // ============================================================================
    // Organizations (组织/学校)
    // ============================================================================
    
    match /organizations/{organizationId} {
      // Platform Admin 可以读写
      // Event Manager 可以读取组织信息
      allow read: if isAuthenticated();
      
      // ✅ Platform Admin 可以创建和修改组织
      allow create: if isPlatformAdmin();
      allow update: if isPlatformAdmin();
      allow delete: if isPlatformAdmin();
      
      // ============================================================================
      // Events (活动)
      // ============================================================================
      
      match /events/{eventId} {
        // 所有认证用户可以读取活动基本信息
        allow read: if isAuthenticated();
        
        // ✅ Event Manager 可以更新活动信息（排除敏感字段）
        // 注意：不再检查 eventManager 对象，因为已迁移到 users 集合
        allow update: if isEventManager(organizationId, eventId) &&
                         !request.resource.data.diff(resource.data).affectedKeys().hasAny([
                           'organizationId', 'orgCode', 'eventCode', 'createdBy', 'createdAt'
                         ]);
        
        // 创建只能通过 Cloud Functions
        allow create, delete: if false;
        
        // ========================================================================
        // Users (活动参与者，包括 Event Manager)
        // ========================================================================
        
        match /users/{userId} {
          /**
           * ✨ 读取规则（使用 Custom Claims）：
           * 1. 用户可以读取自己的信息
           * 2. Event Manager 可以读取所有用户
           * 3. Seller Manager 可以读取所有 Seller（前端客户端过滤管理范围）
           * 4. Finance Manager 可以读取所有 Seller Manager 和 Seller
           */
          allow read: if isInContext(organizationId, eventId);
          
          /**
           * 创建规则：
           * 1. Event Manager 可以创建任何用户
           * 2. 通过 Cloud Functions 创建（注册流程）
           */
          allow create: if isEventManager(organizationId, eventId) ||
                           (isAuthenticated() && request.auth.token.userId == userId);
          
          /**
           * ✅ 更新规则：
           * 1. 用户可以更新自己的基本信息（排除敏感字段）
           * 2. Event Manager 可以更新任何用户（但不能修改自己的 roles）
           * 3. Seller Manager 可以更新管理范围内用户的特定字段
           */
          allow update: if (isAuthenticated() && request.auth.token.userId == userId && 
                           onlyAllowedFields(['basicInfo', 'updatedAt'])) ||
                           (isEventManager(organizationId, eventId) &&
                            // Event Manager 不能修改自己的 roles
                            !(request.auth.token.userId == userId && 
                              request.resource.data.diff(resource.data).affectedKeys().hasAny(['roles']))) ||
                           (isSellerManager(organizationId, eventId) && 
                            isManagedBy(organizationId, eventId, userId, request.auth.uid) &&
                            onlyAllowedFields(['seller', 'pointsStats', 'updatedAt']));
          
          /**
           * ✅ 删除规则：
           * 1. Event Manager 可以删除用户（但不能删除自己）
           * 2. 通过 Cloud Functions 删除
           */
          allow delete: if isEventManager(organizationId, eventId) && 
                           request.auth.token.userId != userId;
          
          // ======================================================================
          // Point Allocations (点数分配记录 - User 级别子集合)
          // ======================================================================
          
          match /pointAllocations/{allocationId} {
            /**
             * 读取规则：
             * 1. 分配者可以读取自己的分配记录
             * 2. 接收者可以读取自己收到的分配
             * 3. Event Manager 可以读取所有分配记录
             * 4. Finance Manager 可以读取所有分配记录
             */
            allow read: if isAuthenticated() && (
                           resource.data.allocatedBy == request.auth.uid ||
                           resource.data.recipientId == request.auth.token.userId ||
                           isEventManager(organizationId, eventId) ||
                           isFinanceManager(organizationId, eventId)
                        );
            
            /**
             * 创建规则：
             * 1. Seller Manager 可以创建点数分配（分配给管理范围内的用户）
             * 2. Finance Manager 可以创建点数分配（分配给 Teacher/Staff）
             * 3. 必须验证 recipientId 和 organizationId/eventId
             */
            allow create: if (isSellerManager(organizationId, eventId) &&
                             request.resource.data.allocatedBy == request.auth.uid &&
                             request.resource.data.organizationId == organizationId &&
                             request.resource.data.eventId == eventId &&
                             isManagedBy(organizationId, eventId, request.resource.data.recipientId, request.auth.uid)) ||
                             (isFinanceManager(organizationId, eventId) &&
                             request.resource.data.allocatedBy == request.auth.uid &&
                             request.resource.data.organizationId == organizationId &&
                             request.resource.data.eventId == eventId);
            
            /**
             * 更新和删除：只能通过 Cloud Functions
             */
            allow update, delete: if false;
          }
        }
        
        // ========================================================================
        // Cash Collections (现金收款记录 - Event 级别集合)
        // ========================================================================
        
        match /cashCollections/{collectionId} {
          /**
           * 读取规则：
           * 1. Seller Manager 可以读取自己创建的记录
           * 2. Finance Manager 可以读取所有记录
           * 3. Event Manager 可以读取所有记录
           * 4. Seller 可以读取自己的收款记录
           */
          allow read: if isEventManager(organizationId, eventId) ||
                         isFinanceManager(organizationId, eventId) ||
                         (isAuthenticated() && resource.data.collectedBy == request.auth.uid) ||
                         (isAuthenticated() && resource.data.sellerId == request.auth.token.userId);
          
          /**
           * 创建规则：
           * 1. Seller Manager 可以创建收款记录
           * 2. 必须验证 sellerId 在管理范围内
           * 3. 必须验证金额 > 0
           */
          allow create: if isSellerManager(organizationId, eventId) &&
                           request.resource.data.collectedBy == request.auth.uid &&
                           request.resource.data.organizationId == organizationId &&
                           request.resource.data.eventId == eventId &&
                           request.resource.data.amount >= 0 &&
                           request.resource.data.sellerId is string &&
                           // 验证 seller 存在且在管理范围内
                           exists(/databases/$(database)/documents/organizations/$(organizationId)/events/$(eventId)/users/$(request.resource.data.sellerId)) &&
                           isManagedBy(organizationId, eventId, request.resource.data.sellerId, request.auth.uid);
          
          /**
           * 更新规则：
           * 1. Seller Manager 可以更新自己创建的记录（仅限特定字段）
           * 2. Finance Manager 可以更新状态
           */
          allow update: if (isSellerManager(organizationId, eventId) &&
                           resource.data.collectedBy == request.auth.uid &&
                           onlyAllowedFields(['note', 'discrepancyReason', 'updatedAt'])) ||
                           (isFinanceManager(organizationId, eventId) &&
                           onlyStatusChange());
          
          /**
           * 删除规则：只能通过 Cloud Functions 或 Event Manager
           */
          allow delete: if isEventManager(organizationId, eventId);
        }
        
        // ========================================================================
        // Cash Submissions (现金上交记录 - Event 级别集合)
        // ========================================================================
        
        match /cashSubmissions/{submissionId} {
          /**
           * 读取规则：
           * 1. Seller Manager 可以读取自己提交的记录
           * 2. Finance Manager 可以读取所有记录
           * 3. Event Manager 可以读取所有记录
           */
          allow read: if isEventManager(organizationId, eventId) ||
                         isFinanceManager(organizationId, eventId) ||
                         (isAuthenticated() && resource.data.submittedBy == request.auth.uid);
          
          /**
           * 创建规则：
           * 1. Seller Manager 可以创建上交记录
           * 2. 必须包含至少一条收款记录
           * 3. 总金额 > 0
           */
          allow create: if isSellerManager(organizationId, eventId) &&
                           request.resource.data.submittedBy == request.auth.uid &&
                           request.resource.data.organizationId == organizationId &&
                           request.resource.data.eventId == eventId &&
                           request.resource.data.type == 'managerToFinance' &&
                           request.resource.data.amount > 0 &&
                           request.resource.data.collectionIds.size() > 0 &&
                           request.resource.data.status == 'pending';
          
          /**
           * 更新规则：
           * 1. Finance Manager 可以更新状态（验证/确认）
           * 2. Seller Manager 可以取消自己提交的待审核记录
           */
          allow update: if (isFinanceManager(organizationId, eventId) &&
                           onlyAllowedFields(['status', 'verifiedAt', 'verifiedBy', 'verifiedAmount', 'discrepancy', 'discrepancyReason', 'notes', 'updatedAt'])) ||
                           (isSellerManager(organizationId, eventId) &&
                           resource.data.submittedBy == request.auth.uid &&
                           resource.data.status == 'pending' &&
                           request.resource.data.status == 'cancelled');
          
          /**
           * 删除规则：只能通过 Cloud Functions 或 Event Manager
           */
          allow delete: if isEventManager(organizationId, eventId);
        }
        
        // ========================================================================
        // Department Stats (部门统计 - Event 级别集合)
        // ========================================================================
        
        match /departmentStats/{departmentCode} {
          /**
           * 读取规则：
           * 1. Event Manager 可以读取所有部门统计
           * 2. Seller Manager 可以读取管理的部门统计
           * 3. Finance Manager 可以读取所有部门统计
           */
          allow read: if isEventManager(organizationId, eventId) ||
                         isFinanceManager(organizationId, eventId) ||
                         (isSellerManager(organizationId, eventId) &&
                          managesDepartment(organizationId, eventId, departmentCode));
          
          /**
           * 写入规则：只能通过 Cloud Functions（自动维护统计）
           */
          allow write: if false;
        }
        
        // ========================================================================
        // Seller Manager Stats (SM 统计 - Event 级别集合)
        // ========================================================================
        
        match /sellerManagerStats/{sellerManagerId} {
          /**
           * 读取规则：
           * 1. Seller Manager 可以读取自己的统计
           * 2. Event Manager 可以读取所有 SM 统计
           * 3. Finance Manager 可以读取所有 SM 统计
           */
          allow read: if (isAuthenticated() && request.auth.token.userId == sellerManagerId) ||
                         isEventManager(organizationId, eventId) ||
                         isFinanceManager(organizationId, eventId);
          
          /**
           * 写入规则：只能通过 Cloud Functions（自动维护统计）
           */
          allow write: if false;
        }
        
        // ========================================================================
        // Finance Manager Stats (FM 统计 - Event 级别集合)
        // ========================================================================
        
        match /financeManagerStats/{financeManagerId} {
          /**
           * 读取规则：
           * 1. Finance Manager 可以读取自己的统计
           * 2. Event Manager 可以读取所有 FM 统计
           */
          allow read: if (isAuthenticated() && request.auth.token.userId == financeManagerId) ||
                         isEventManager(organizationId, eventId);
          
          /**
           * 写入规则：只能通过 Cloud Functions（自动维护统计）
           */
          allow write: if false;
        }
        
        // ========================================================================
        // Transactions (交易记录 - Event 级别集合)
        // ========================================================================
        
        match /transactions/{transactionId} {
          /**
           * 读取规则：
           * 1. 交易双方可以读取
           * 2. Event Manager 可以读取所有交易
           * 3. Finance Manager 可以读取所有交易
           */
          allow read: if isEventManager(organizationId, eventId) ||
                         isFinanceManager(organizationId, eventId) ||
                         (isAuthenticated() && 
                          (resource.data.sellerId == request.auth.token.userId || 
                           resource.data.customerId == request.auth.token.userId));
          
          /**
           * 创建规则：
           * 1. Seller 可以创建交易（自己作为 seller）
           * 2. 必须验证余额充足
           */
          allow create: if isAuthenticated() &&
                           hasRole('seller') &&
                           request.resource.data.sellerId == request.auth.token.userId &&
                           request.resource.data.points > 0;
          
          /**
           * 更新和删除：只能通过 Cloud Functions
           */
          allow update, delete: if false;
        }
      }
    }
    
    // ============================================================================
    // 默认规则：拒绝所有其他访问
    // ============================================================================
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
