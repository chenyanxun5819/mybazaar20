rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ğŸ”¥ è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è®¤è¯
    function isSignedIn() {
      return request.auth != null;
    }
    
    // ğŸ”¥ è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥æ˜¯å¦åŒ¹é…ä»»ä¸€ authUid å­—æ®µ
    function matchesAuthUid() {
      return isSignedIn() && (
        request.auth.uid == resource.data.authUid ||
        request.auth.uid == resource.data.authId ||
        (resource.data.accountStatus != null && 
         request.auth.uid == resource.data.accountStatus.authUid)
      );
    }
    
    // ==========================================
    // ç»„ç»‡ > æ´»åŠ¨ > ç”¨æˆ·
    // ==========================================
    match /organizations/{orgId}/events/{eventId}/users/{userId} {
      // ğŸ”¥ è¯»å–æƒé™ï¼šå·²ç™»å½•ç”¨æˆ·å¯ä»¥è¯»å–è‡ªå·±çš„æ•°æ®
      allow read: if matchesAuthUid();
      
      // ğŸ”¥ æ›´æ–°æƒé™ï¼šç”¨æˆ·å¯ä»¥æ›´æ–°è‡ªå·±çš„æŸäº›å­—æ®µ
      allow update: if matchesAuthUid() && (
        // ä¸èƒ½ä¿®æ”¹å…³é”®å­—æ®µ
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['roles', 'authUid', 'authId', 'accountStatus'])
      );
      
      // ğŸ”¥ åˆ›å»ºå’Œåˆ é™¤ï¼šåªå…è®¸ Cloud Functions
      allow create, delete: if false;
    }
    
    // ==========================================
    // ç»„ç»‡åŸºæœ¬ä¿¡æ¯
    // ==========================================
    match /organizations/{orgId} {
      allow read: if true;
      allow write: if false;
    }
    
    // ==========================================
    // æ´»åŠ¨åŸºæœ¬ä¿¡æ¯
    // ==========================================
    match /organizations/{orgId}/events/{eventId} {
      allow read: if true;
      allow write: if false;
    }
    
    // ==========================================
    // ç®¡ç†å‘˜é›†åˆ
    // ==========================================
    match /managers/{managerId} {
      allow read: if isSignedIn();
      allow write: if false;
    }
    
    // ==========================================
    // OTP ä¼šè¯
    // ==========================================
    match /otp_sessions/{sessionId} {
      allow read, write: if false;
    }
    
    // ==========================================
    // è¯Šæ–­æµ‹è¯•é›†åˆ
    // ==========================================
    match /_diagnostic_test/{document=**} {
      allow read: if isSignedIn();
      allow write: if false;
    }
    
    // ==========================================
    // é»˜è®¤è§„åˆ™
    // ==========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}