rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================================
    // è¾…åŠ©å‡½æ•° (Helper Functions)
    // ============================================================================
    
    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è®¤è¯
     */
    function isAuthenticated() {
      return request.auth != null;
    }
    
    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯æ–‡æ¡£æ‰€æœ‰è€…
     */
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    /**
     * âœ¨ æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ç‰¹å®šè§’è‰²ï¼ˆä» Custom Claims è¯»å–ï¼‰
     * âœ… ä¿®å¤ 2024-12-14: æ”¯æŒ roles æ•°ç»„æ ¼å¼
     */
    function hasRole(role) {
      return isAuthenticated() && 
             request.auth.token.roles != null &&
             request.auth.token.roles.hasAny([role]);
    }


    
    /**
     * âœ¨ æ£€æŸ¥ Custom Claims ä¸­çš„ organizationId å’Œ eventId æ˜¯å¦åŒ¹é…
     * ğŸ”¥ ä¸´æ—¶å®½æ¾ç‰ˆæœ¬ï¼šåªæ£€æŸ¥æ˜¯å¦å·²è®¤è¯
     */
    function isInContext(orgId, eventId) {
      // åš´æ ¼ç‰ˆï¼šclaims å¿…é ˆèˆ‡è·¯å¾‘åƒæ•¸ä¸€è‡´
      return isAuthenticated() &&
             request.auth.token.organizationId == orgId &&
             request.auth.token.eventId == eventId;
    }
    
    /**
     * âœ… æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯ Event Managerï¼ˆä» Custom Claims è¯»å–ï¼‰
     * æ–°æ¶æ„ï¼šEvent Manager å­˜å‚¨åœ¨ users é›†åˆä¸­ï¼Œé€šè¿‡ roles=['eventManager'] è¯†åˆ«
     */
    function isEventManager(orgId, eventId) {
      return isInContext(orgId, eventId) && hasRole('eventManager');
    }
    
    /**
     * âœ¨ æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯ Seller Managerï¼ˆä» Custom Claims è¯»å–ï¼‰
     */
    function isSellerManager(orgId, eventId) {
      return isInContext(orgId, eventId) && hasRole('sellerManager');
    }
    
    /**
     * âœ¨ æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯ Cashierï¼ˆä» Custom Claims è¯»å–ï¼‰
     */
    function isCashier(orgId, eventId) {
      return isInContext(orgId, eventId) && hasRole('cashier');
    }
    
    /**
     * âœ¨ æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç®¡ç†ç‰¹å®šéƒ¨é—¨ï¼ˆä» Custom Claims è¯»å–ï¼‰
     */
    function managesDepartment(orgId, eventId, departmentCode) {
      return isAuthenticated() && 
             isInContext(orgId, eventId) &&
             hasRole('sellerManager') &&
             request.auth.token.managedDepartments != null &&
             departmentCode in request.auth.token.managedDepartments;
    }
    
    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¢«ç‰¹å®š Seller Manager ç®¡ç†
     */
    function isManagedBy(orgId, eventId, sellerId, managerId) {
      let seller = get(/databases/$(database)/documents/organizations/$(orgId)/events/$(eventId)/users/$(sellerId)).data;
      return seller.managedBy.hasAny([managerId]);
    }
    
    /**
     * æ£€æŸ¥æ˜¯å¦åªæ›´æ–°çŠ¶æ€å­—æ®µ
     */
    function onlyStatusChange() {
      let affectedKeys = request.resource.data.diff(resource.data).affectedKeys();
      return affectedKeys.hasOnly(['status', 'updatedAt', 'verifiedAt', 'verifiedBy']);
    }
    
    /**
     * æ£€æŸ¥æ˜¯å¦åªæ›´æ–°å…è®¸çš„å­—æ®µ
     */
    function onlyAllowedFields(allowedFields) {
      let affectedKeys = request.resource.data.diff(resource.data).affectedKeys();
      return affectedKeys.hasOnly(allowedFields);
    }
    
    // ============================================================================
    // Platform Admin (å¹³å°ç®¡ç†å‘˜)
    // ============================================================================
    function isPlatformAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/admin_uids/$(request.auth.uid));
    }

    match /admin_uids/{adminUid} {
      // Platform Admin å¯ä»¥è¯»å–è‡ªå·±çš„ä¿¡æ¯
      allow read: if isOwner(adminUid);
      
      // åˆ›å»ºå’Œä¿®æ”¹éœ€è¦è¶…çº§ç®¡ç†å‘˜æƒé™ï¼ˆé€šè¿‡ Cloud Functionsï¼‰
      allow write: if false;
    }
    
    // ============================================================================
    // Organizations (ç»„ç»‡/å­¦æ ¡)
    // ============================================================================
    
    match /organizations/{organizationId} {
      // âœ… å…è®¸æ‰€æœ‰äººè¯»å–ç»„ç»‡åŸºæœ¬ä¿¡æ¯ï¼ˆç”¨äºç™»å½•é¡µé¢æ˜¾ç¤ºï¼‰
      // æ³¨æ„ï¼šorganizations åªåŒ…å« orgCode, name ç­‰éæ•æ„Ÿä¿¡æ¯
      allow read: if true;
      
      // âœ… Platform Admin å¯ä»¥åˆ›å»ºå’Œä¿®æ”¹ç»„ç»‡
      allow create: if isPlatformAdmin();
      allow update: if isPlatformAdmin();
      allow delete: if isPlatformAdmin();
      
      // ============================================================================
      // Events (æ´»åŠ¨)
      // ============================================================================
      
      match /events/{eventId} {
        // âœ… å…è®¸æ‰€æœ‰äººè¯»å–æ´»åŠ¨åŸºæœ¬ä¿¡æ¯ï¼ˆç”¨äºç™»å½•é¡µé¢æ˜¾ç¤ºï¼‰
        // æ³¨æ„ï¼ševents åªåŒ…å« eventCode, name, dates ç­‰éæ•æ„Ÿä¿¡æ¯
        allow read: if true;
        
        // âœ… Event Manager å¯ä»¥æ›´æ–°æ´»åŠ¨ä¿¡æ¯ï¼ˆæ’é™¤æ•æ„Ÿå­—æ®µï¼‰
        // æ³¨æ„ï¼šä¸å†æ£€æŸ¥ eventManager å¯¹è±¡ï¼Œå› ä¸ºå·²è¿ç§»åˆ° users é›†åˆ
        allow update: if isEventManager(organizationId, eventId) &&
                         !request.resource.data.diff(resource.data).affectedKeys().hasAny([
                           'organizationId', 'orgCode', 'eventCode', 'createdBy', 'createdAt'
                         ]);
        
        // åˆ›å»ºåªèƒ½é€šè¿‡ Cloud Functions
        allow create, delete: if false;
        
        // ========================================================================
        // Users (æ´»åŠ¨å‚ä¸è€…ï¼ŒåŒ…æ‹¬ Event Manager)
        // ========================================================================
        
        match /users/{userId} {
          /**
           * âœ¨ è¯»å–è§„åˆ™ï¼ˆä½¿ç”¨ Custom Claimsï¼‰ï¼š
           * 1. ç”¨æˆ·å¯ä»¥è¯»å–è‡ªå·±çš„æ•°æ®
           * 2. Event Manager å¯ä»¥è¯»å–æ‰€æœ‰ç”¨æˆ·
           * 3. å…¶ä»–å·²è®¤è¯ç”¨æˆ·å¯ä»¥è¯»å–ï¼ˆæš‚æ—¶æ”¾å®½ä»¥æ”¯æŒé”€å”®æµç¨‹ï¼‰
           */
          allow read: if isAuthenticated() && (
                         request.auth.token.userId == userId ||
                         isEventManager(organizationId, eventId)
                       ) ||
                       isAuthenticated(); // æš‚æ—¶æ”¾å®½ä»¥æ”¯æŒé”€å”®æµç¨‹
          
          /**
           * åˆ›å»ºè§„åˆ™ï¼š
           * 1. Event Manager å¯ä»¥åˆ›å»ºä»»ä½•ç”¨æˆ·
           * 2. é€šè¿‡ Cloud Functions åˆ›å»ºï¼ˆæ³¨å†Œæµç¨‹ï¼‰
           */
          allow create: if isEventManager(organizationId, eventId) ||
                           (isAuthenticated() && request.auth.token.userId == userId);
          
          /**
           * âœ… æ›´æ–°è§„åˆ™ï¼š
           * 1. ç”¨æˆ·å¯ä»¥æ›´æ–°è‡ªå·±çš„æ•°æ®ï¼Œä½†ä¸èƒ½ä¿®æ”¹å¯†ç /PINç›¸å…³å­—æ®µ
           * 2. Event Manager å¯ä»¥æ›´æ–°ä»»ä½•ç”¨æˆ·ï¼ˆä½†ä¸èƒ½ä¿®æ”¹è‡ªå·±çš„ rolesï¼‰
           * 3. Seller Manager å¯ä»¥æ›´æ–°ç®¡ç†èŒƒå›´å†…ç”¨æˆ·çš„ç‰¹å®šå­—æ®µ
           * 4. ç¦æ­¢ç›´æ¥ä¿®æ”¹å¯†ç ç›¸å…³å­—æ®µï¼ˆpasswordHash, passwordSalt, transactionPinHash, transactionPinSaltï¼‰
           */
          allow update: if (isAuthenticated() && request.auth.token.userId == userId && 
                           onlyAllowedFields(['basicInfo', 'updatedAt']) &&
                           !request.resource.data.basicInfo.diff(resource.data.basicInfo)
                             .affectedKeys().hasAny(['passwordHash', 'passwordSalt', 'transactionPinHash', 'transactionPinSalt', 'pinHash', 'pinSalt'])) ||
                           // å…è¨± Seller Manager æ›´æ–°è‡ªå·±çš„ç¾é‡‘çµ±è¨ˆï¼ˆæ”¶æ¬¾/ä¸Šäº¤ç­‰ï¼‰ï¼Œåƒ…é™ pointsStats èˆ‡æ™‚é–“æˆ³
                           (isSellerManager(organizationId, eventId) &&
                            request.auth.token.userId == userId &&
                            onlyAllowedFields(['pointsStats', 'updatedAt'])) ||
                           (isEventManager(organizationId, eventId) &&
                            // Event Manager ä¸èƒ½ä¿®æ”¹è‡ªå·±çš„ roles
                            !(request.auth.token.userId == userId && 
                              request.resource.data.diff(resource.data).affectedKeys().hasAny(['roles']))) ||
                           (isSellerManager(organizationId, eventId) && 
                            isManagedBy(organizationId, eventId, userId, request.auth.token.userId) &&
                            onlyAllowedFields(['seller', 'pointsStats', 'updatedAt'])) ||
                           (isAuthenticated() && 
                            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['seller', 'updatedAt'])) ||
                           (isAuthenticated() && 
                            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['merchant', 'updatedAt'])) ||
                           (isAuthenticated() && 
                            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['customer', 'updatedAt'])) ||
                           // ğŸ”¥ æš«æ™‚æ”¾å¯¬ï¼šå…è¨±å¯«å…¥ roleSpecificDataï¼ˆåƒ…ç‚ºäº†ç¾æœ‰è³‡æ–™çµæ§‹å…¼å®¹ï¼‰
                           (isAuthenticated() && 
                            onlyAllowedFields(['roleSpecificData', 'updatedAt']));
          
          /**
           * âœ… åˆ é™¤è§„åˆ™ï¼š
           * 1. Event Manager å¯ä»¥åˆ é™¤ç”¨æˆ·ï¼ˆä½†ä¸èƒ½åˆ é™¤è‡ªå·±ï¼‰
           * 2. é€šè¿‡ Cloud Functions åˆ é™¤
           */
          allow delete: if isEventManager(organizationId, eventId) && 
                           request.auth.token.userId != userId;
          
        // ======================================================================
        // Point Allocations (ç‚¹æ•°åˆ†é…è®°å½• - users å­é›†åˆ)
        // âœ… æ·»åŠ åœ¨ users/{userId} è§„åˆ™å†…éƒ¨ï¼Œç¬¬217è¡Œå
        // ======================================================================

        match /pointAllocations/{allocationId} {
          /**
          * è¯»å–è§„åˆ™ï¼š
          * 1. Seller Manager å¯ä»¥è¯»å–è‡ªå·±çš„åˆ†é…è®°å½•
          * 2. Event Manager å¯ä»¥è¯»å–æ‰€æœ‰åˆ†é…è®°å½•
          * 3. Seller å¯ä»¥è¯»å–åˆ†é…ç»™è‡ªå·±çš„è®°å½•
          */
          allow read: if (isAuthenticated() && request.auth.token.userId == userId) ||
                        isEventManager(organizationId, eventId) ||
                        (isAuthenticated() && resource.data.recipientId == request.auth.token.userId);
          
          /**
          * åˆ›å»ºè§„åˆ™ï¼š
          * 1. Seller Manager å¯ä»¥åˆ›å»ºåˆ†é…è®°å½•ï¼ˆåªèƒ½åœ¨è‡ªå·±çš„æ–‡æ¡£ä¸‹ï¼‰
          * 2. Event Manager å¯ä»¥åˆ›å»º
          */
          allow create: if (isSellerManager(organizationId, eventId) && 
                          request.auth.token.userId == userId) ||
                          isEventManager(organizationId, eventId);
          
          /**
          * æ›´æ–°å’Œåˆ é™¤ï¼šåªèƒ½é€šè¿‡ Cloud Functions
          */
          allow update, delete: if false;
        }

        // ======================================================================
        // Cash Collections (ç°é‡‘æ”¶å–è®°å½• - users å­é›†åˆ)
        // âœ… å¯é€‰ï¼šå¦‚æœéœ€è¦æ”¶æ¬¾åŠŸèƒ½
        // ======================================================================

        match /cashCollections/{collectionId} {
          /**
          * è¯»å–è§„åˆ™ï¼š
          * 1. Seller Manager å¯ä»¥è¯»å–è‡ªå·±çš„æ”¶æ¬¾è®°å½•
          * 2. Event Manager å¯ä»¥è¯»å–æ‰€æœ‰æ”¶æ¬¾è®°å½•
          * 3. Seller å¯ä»¥è¯»å–è‡ªå·±è¢«æ”¶æ¬¾çš„è®°å½•
          * 4. Cashier å¯ä»¥è¯»å–æ‰€æœ‰æ”¶æ¬¾è®°å½•
          */
          allow read: if (isAuthenticated() && request.auth.token.userId == userId) ||
                        isEventManager(organizationId, eventId) ||
                        isCashier(organizationId, eventId) ||
                        (isAuthenticated() && resource.data.sellerId == request.auth.token.userId);
          
          /**
          * åˆ›å»ºè§„åˆ™ï¼š
          * 1. Seller Manager å¯ä»¥åˆ›å»ºæ”¶æ¬¾è®°å½•
          * 2. Event Manager å¯ä»¥åˆ›å»º
          */
          allow create: if (isSellerManager(organizationId, eventId) && 
                          request.auth.token.userId == userId) ||
                          isEventManager(organizationId, eventId);
          
          /**
          * æ›´æ–°å’Œåˆ é™¤ï¼šåªèƒ½é€šè¿‡ Cloud Functions
          */
          allow update, delete: if false;
        }

        }

        // ========================================================================
        // Merchants (å•†å®¶æ”¤ä½ - Event ç´šåˆ¥é›†åˆ)
        // ========================================================================
        match /merchants/{merchantId} {
          /**
           * è®€å–è¦å‰‡ï¼šæš«æ™‚æ”¾å¯¬ï¼Œæ‰€æœ‰å·²èªè­‰ä½¿ç”¨è€…å¯è®€å–
           * ä¾¿æ–¼å•†å®¶ç«¯è¼‰å…¥è‡ªå·±çš„è³‡æ–™èˆ‡æ¸¬è©¦
           */
          allow read: if isAuthenticated();

          /**
           * æ›´æ–°è¦å‰‡ï¼šåƒ…å…è¨±å•†å®¶æœ¬äººæ›´æ–°æœ‰é™æ¬„ä½
           * æ ¸å°æ¢ä»¶ï¼šæ–‡ä»¶ä¸­çš„ userId å¿…é ˆç­‰æ–¼ Custom Claims çš„ userId æˆ– request.auth.uid
           * å¯æ›´æ–°æ¬„ä½ï¼šstallName, description, contactInfo, isActive, updatedAt
           */
          allow update: if isAuthenticated() &&
                         (resource.data.userId == request.auth.token.userId ||
                          resource.data.userId == request.auth.uid) &&
                         onlyAllowedFields(['stallName', 'description', 'contactInfo', 'isActive', 'updatedAt']);

          /**
           * å»ºç«‹èˆ‡åˆªé™¤ï¼šåƒ…å…è¨±ç¶“ç”± Cloud Functions
           */
          allow create, delete: if false;
        }
        
        // ========================================================================
        // Cash Collections (ç°é‡‘æ”¶æ¬¾è®°å½• - Event çº§åˆ«é›†åˆ)
        // ========================================================================
        
        match /cashCollections/{collectionId} {
          /**
           * âœ… è¯»å–è§„åˆ™ï¼ˆä¿®å¤ 2024-12-14ï¼‰
           * ä½¿ç”¨ request.auth.token.userId åŒ¹é… collectedBy
           */
          allow read: if isAuthenticated();
          
          /**
           * âœ… åˆ›å»ºè§„åˆ™ï¼ˆä¿®å¤ 2024-12-14ï¼‰
           * å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨ request.auth.token.userId è€Œä¸æ˜¯ request.auth.uid
           * åŸå› ï¼šcollectedBy å­˜å‚¨çš„æ˜¯åº”ç”¨å†…éƒ¨ userIdï¼Œä¸æ˜¯ Firebase Auth UID
           */
          allow create: if isAuthenticated() &&
                           // å¿…é¡»åŒ…å«å¿…å¡«å­—æ®µ
                           request.resource.data.keys().hasAll([
                             'collectedBy', 'submittedBy', 'amount',
                             'status', 'eventId', 'organizationId'
                           ]) &&
                           // âœ… ä½¿ç”¨ Custom Claims ä¸­çš„ userId
                           (request.resource.data.collectedBy == request.auth.token.userId ||
                            request.resource.data.collectedBy == request.auth.uid) &&
                           // é‡‘é¢å¿…é¡» > 0
                           request.resource.data.amount > 0 &&
                           // çŠ¶æ€å¿…é¡»æ˜¯ collected
                           request.resource.data.status == 'collected' &&
                           // organizationId å’Œ eventId å¿…é¡»åŒ¹é…
                           request.resource.data.organizationId == organizationId &&
                           request.resource.data.eventId == eventId;
          
          /**
           * âœ… æ›´æ–°è§„åˆ™ï¼ˆä¿®å¤ 2024-12-14ï¼‰
           * ä½¿ç”¨ request.auth.token.userId åŒ¹é… collectedBy
           */
          allow update: if (isSellerManager(organizationId, eventId) &&
                           resource.data.collectedBy == request.auth.token.userId &&
                           onlyAllowedFields(['note', 'discrepancyReason', 'updatedAt'])) ||
                           (isCashier(organizationId, eventId) &&
                           onlyStatusChange());
          
          /**
           * åˆ é™¤è§„åˆ™ï¼šåªèƒ½é€šè¿‡ Cloud Functions æˆ– Event Manager
           */
          allow delete: if isEventManager(organizationId, eventId);
        }
        
        // ========================================================================
        // Cash Submissions (ç°é‡‘ä¸Šäº¤è®°å½• - Event çº§åˆ«é›†åˆ)
        // ========================================================================
        
        match /cashSubmissions/{submissionId} {
          /**
           * âœ… è¯»å–è§„åˆ™ï¼ˆä¿®å¤ç‰ˆï¼‰
           * 1. Seller å¯ä»¥è¯»å–è‡ªå·±æäº¤çš„è®°å½•
           * 2. Seller Manager å¯ä»¥è¯»å–è‡ªå·±æäº¤çš„å’Œæ”¶åˆ°çš„è®°å½•
           * 3. Cashier å¯ä»¥è¯»å–æ‰€æœ‰è®°å½•
           * 4. Event Manager å¯ä»¥è¯»å–æ‰€æœ‰è®°å½•
           */
          allow read: if isEventManager(organizationId, eventId) ||
                         isCashier(organizationId, eventId) ||
                         isCashier(organizationId, eventId) ||
                         (isAuthenticated() && resource.data.submittedBy == request.auth.token.userId) ||
                         (isSellerManager(organizationId, eventId) && 
                          resource.data.receivedBy == request.auth.token.userId);
          
          /**
           * âœ… åˆ›å»ºè§„åˆ™ï¼ˆä¿®å¤ç‰ˆï¼‰
           * 1. Seller å¯ä»¥åˆ›å»ºä¸Šäº¤è®°å½•ï¼ˆç»™ Seller Manager æˆ–å¾…è®¤é¢†æ± å­ï¼‰
           * 2. Seller Manager å¯ä»¥åˆ›å»ºä¸Šäº¤è®°å½•ï¼ˆç»™ Finance Managerï¼‰
           * 3. Point Seller å¯ä»¥åˆ›å»ºä¸Šäº¤è®°å½•ï¼ˆç»™ Finance Managerï¼‰
           * 4. å¿…é¡»åŒ…å«å¿…å¡«å­—æ®µ
           * 5. çŠ¶æ€å¿…é¡»æ˜¯ pending
           * 6. organizationId å’Œ eventId å¿…é¡»åŒ¹é…
           */
          allow create: if isAuthenticated() &&
                           request.resource.data.keys().hasAll([
                             'submittedBy', 'submitterRole', 'amount',
                             'status', 'eventId', 'organizationId'
                           ]) &&
                           request.resource.data.submittedBy == request.auth.token.userId &&
                           request.resource.data.amount > 0 &&
                           request.resource.data.status == 'pending' &&
                           request.resource.data.organizationId == organizationId &&
                           request.resource.data.eventId == eventId &&
                           (hasRole('seller') || hasRole('sellerManager') || hasRole('pointSeller'));
          
          /**
           * âœ… æ›´æ–°è§„åˆ™ï¼ˆä¿®å¤ç‰ˆï¼‰
           * 1. Seller Manager å¯ä»¥å–æ¶ˆè‡ªå·±æäº¤çš„å¾…å®¡æ ¸è®°å½•
           * 2. Cashier å¯ä»¥æ›´æ–°çŠ¶æ€ï¼ˆç¡®è®¤/æ‹’ç»/äº‰è®®ï¼‰
           * 3. åªèƒ½ä¿®æ”¹ç‰¹å®šå­—æ®µ
           */
          allow update: if (isSellerManager(organizationId, eventId) &&
                           resource.data.submittedBy == request.auth.token.userId &&
                           resource.data.status == 'pending' &&
                           request.resource.data.status == 'cancelled' &&
                           onlyAllowedFields(['status', 'updatedAt'])) ||
                           (isCashier(organizationId, eventId) &&
                           onlyAllowedFields(['status', 'verifiedAt', 'verifiedBy', 'verifiedAmount', 'discrepancy', 'discrepancyReason', 'notes', 'updatedAt', 'confirmationNote', 'receivedBy', 'receiverName']));
          
          /**
           * âœ… åˆ é™¤è§„åˆ™ï¼šåªèƒ½é€šè¿‡ Cloud Functions æˆ– Event Manager
           */
          allow delete: if isEventManager(organizationId, eventId);
        }
        
        // ========================================================================
        // Department Stats (éƒ¨é—¨ç»Ÿè®¡ - Event çº§åˆ«é›†åˆ)
        // ========================================================================
        
        match /departmentStats/{departmentCode} {
          /**
           * è¯»å–è§„åˆ™ï¼š
           * 1. Event Manager å¯ä»¥è¯»å–æ‰€æœ‰éƒ¨é—¨ç»Ÿè®¡
           * 2. Seller Manager å¯ä»¥è¯»å–ç®¡ç†çš„éƒ¨é—¨ç»Ÿè®¡
           * 3. Cashier å¯ä»¥è¯»å–æ‰€æœ‰éƒ¨é—¨ç»Ÿè®¡
           */
          allow read: if isEventManager(organizationId, eventId) ||
                         isCashier(organizationId, eventId) ||
                         (isSellerManager(organizationId, eventId) &&
                          managesDepartment(organizationId, eventId, departmentCode));
          
          /**
           * å†™å…¥è§„åˆ™ï¼šåªèƒ½é€šè¿‡ Cloud Functionsï¼ˆè‡ªåŠ¨ç»´æŠ¤ç»Ÿè®¡ï¼‰
           */
          allow write: if false;
        }
        
        // ========================================================================
        // Seller Manager Stats (SM ç»Ÿè®¡ - Event çº§åˆ«é›†åˆ)
        // ========================================================================
        
        match /sellerManagerStats/{sellerManagerId} {
          /**
           * è¯»å–è§„åˆ™ï¼š
           * 1. Seller Manager å¯ä»¥è¯»å–è‡ªå·±çš„ç»Ÿè®¡
           * 2. Event Manager å¯ä»¥è¯»å–æ‰€æœ‰ SM ç»Ÿè®¡
           * 3. Cashier å¯ä»¥è¯»å–æ‰€æœ‰ SM ç»Ÿè®¡
           */
          allow read: if (isAuthenticated() && request.auth.token.userId == sellerManagerId) ||
                         isEventManager(organizationId, eventId) ||
                         isCashier(organizationId, eventId);
          
          /**
           * å†™å…¥è§„åˆ™ï¼šåªèƒ½é€šè¿‡ Cloud Functionsï¼ˆè‡ªåŠ¨ç»´æŠ¤ç»Ÿè®¡ï¼‰
           */
          allow write: if false;
        }
        
        // ========================================================================
        // Cashier Stats (Cashier ç»Ÿè®¡ - Event çº§åˆ«é›†åˆ)
        // ========================================================================
        
        match /cashierStats/{cashierId} {
          /**
           * è¯»å–è§„åˆ™ï¼š
           * 1. Cashier å¯ä»¥è¯»å–è‡ªå·±çš„ç»Ÿè®¡
           * 2. Event Manager å¯ä»¥è¯»å–æ‰€æœ‰ Cashier ç»Ÿè®¡
           */
          allow read: if (isAuthenticated() && request.auth.token.userId == cashierId) ||
                         isEventManager(organizationId, eventId);
          
          /**
           * å†™å…¥è§„åˆ™ï¼šåªèƒ½é€šè¿‡ Cloud Functionsï¼ˆè‡ªåŠ¨ç»´æŠ¤ç»Ÿè®¡ï¼‰
           */
          allow write: if false;
        }
        
        // ========================================================================
        // Transactions (äº¤æ˜“è®°å½• - Event çº§åˆ«é›†åˆ)
        // ========================================================================
        
        match /transactions/{transactionId} {
          /**
           * ğŸ”¥ ä¸´æ—¶å®½æ¾è¯»å–è§„åˆ™ï¼šå…è®¸æ‰€æœ‰å·²è®¤è¯ç”¨æˆ·è¯»å–
           * ç”¨äºæµ‹è¯•å’Œè°ƒè¯•
           */
          allow read: if isAuthenticated();
          
          /**
           * åˆ›å»ºè§„åˆ™ï¼š
           * ğŸ”¥ ä¸´æ—¶å®½æ¾ç‰ˆæœ¬ï¼šå…è®¸æ‰€æœ‰å·²è®¤è¯ç”¨æˆ·åˆ›å»º
           */
          // æ”¶ç·Šï¼šéœ€å·²èªè­‰ã€ä¸”äº¤æ˜“æ–‡ä»¶çš„ org/event èˆ‡è·¯å¾‘ä¸€è‡´
          allow create: if isAuthenticated() &&
                           request.resource.data.organizationId == organizationId &&
                           request.resource.data.eventId == eventId;
          
          /**
           * æ›´æ–°å’Œåˆ é™¤ï¼šåªèƒ½é€šè¿‡ Cloud Functions
           */
          allow update, delete: if false;
        }
        
        // ========================================================================
        // Point Cards (ç‚¹æ•°å¡ - Event çº§åˆ«é›†åˆ)
        // ========================================================================
        
        match /pointCards/{cardId} {
          /**
           * è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥æ˜¯å¦ä¸º PointSeller
           */
          function isPointSeller() {
            return isAuthenticated() && 
                   hasRole('pointSeller') &&
                   isInContext(organizationId, eventId);
          }
          
          /**
           * è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥æ˜¯å¦ä¸º Merchant
           */
          function isMerchant() {
            return isAuthenticated() && 
                   hasRole('merchant') &&
                   isInContext(organizationId, eventId);
          }
          
          /**
           * åˆ›å»ºè§„åˆ™ï¼š
           * PointSeller å¯ä»¥åˆ›å»ºç‚¹æ•°å¡ï¼ˆå¿…é¡»è®¾ç½®è‡ªå·±ä¸º issuerï¼‰
           */
          allow create: if isPointSeller() && 
                           request.resource.data.issuer.pointSellerId == request.auth.uid &&
                           request.resource.data.organizationId == organizationId &&
                           request.resource.data.eventId == eventId;
          
          /**
           * è¯»å–è§„åˆ™ï¼š
           * 1. PointSeller å¯ä»¥è¯»å–è‡ªå·±å‘è¡Œçš„ç‚¹æ•°å¡
           * 2. Merchant å¯ä»¥è¯»å–æ‰€æœ‰ç‚¹æ•°å¡ï¼ˆç”¨äºæ‰«ç æ”¶æ¬¾éªŒè¯ä½™é¢ï¼‰
           * 3. Cashier å¯ä»¥è¯»å–æ‰€æœ‰ç‚¹æ•°å¡ï¼ˆç”¨äºè´¢åŠ¡ç®¡ç†ï¼‰
           * 4. Event Manager å¯ä»¥è¯»å–æ‰€æœ‰ç‚¹æ•°å¡ï¼ˆç”¨äºç³»ç»Ÿç®¡ç†ï¼‰
           */
          allow read: if (isPointSeller() && 
                         resource.data.issuer.pointSellerId == request.auth.uid) ||
                         isMerchant() ||
                         isCashier(organizationId, eventId) ||
                         isEventManager(organizationId, eventId);
          
          /**
           * æ›´æ–°è§„åˆ™ï¼š
           * 1. Merchant å¯ä»¥æ›´æ–°ç‚¹æ•°å¡ä½™é¢ï¼ˆæ‰«ç æ”¶æ¬¾æ—¶ï¼‰
           * 2. åªèƒ½ä¿®æ”¹ä½™é¢ç›¸å…³å­—æ®µ
           */
          allow update: if isMerchant() &&
                           onlyAllowedFields(['balance', 'transactions', 'updatedAt', 'metadata']);
          
          /**
           * åˆ é™¤è§„åˆ™ï¼š
           * åªèƒ½é€šè¿‡ Cloud Functions æˆ– Event Manager
           */
          allow delete: if isEventManager(organizationId, eventId);
        }
      }
    }
    
    // ============================================================================
    // é»˜è®¤è§„åˆ™ï¼šæ‹’ç»æ‰€æœ‰å…¶ä»–è®¿é—®
    // ============================================================================
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
