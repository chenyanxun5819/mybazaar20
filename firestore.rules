rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ğŸ”¥ è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è®¤è¯
    function isSignedIn() {
      return request.auth != null;
    }
    
    // ğŸ”¥ è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥æ˜¯å¦æ˜¯ç”¨æˆ·è‡ªå·±çš„æ•°æ®
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // ğŸ”¥ è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥æ˜¯å¦æ˜¯ç”¨æˆ·è‡ªå·±çš„æ•°æ®ï¼ˆé€šè¿‡ authUid å­—æ®µï¼‰
    function isOwnerByAuthUid() {
      return isSignedIn() && (
        request.auth.uid == resource.data.authUid ||
        request.auth.uid == resource.data.authId ||
        request.auth.uid == get(/databases/$(database)/documents/organizations/$(orgId)/events/$(eventId)/users/$(userId)).data.authUid
      );
    }
    
    // ==========================================
    // ç»„ç»‡ > æ´»åŠ¨ > ç”¨æˆ·
    // ==========================================
    match /organizations/{orgId}/events/{eventId}/users/{userId} {
      // ğŸ”¥ è¯»å–æƒé™ï¼š
      // 1. å·²ç™»å½•ç”¨æˆ·å¯ä»¥è¯»å–è‡ªå·±çš„æ•°æ®ï¼ˆé€šè¿‡ authUid åŒ¹é…ï¼‰
      // 2. å…è®¸é€šè¿‡å¤šä¸ªå¯èƒ½çš„ authUid å­—æ®µåŒ¹é…
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.authUid ||
        request.auth.uid == resource.data.authId ||
        request.auth.uid == resource.data.get('accountStatus', {}).get('authUid', '')
      );
      
      // ğŸ”¥ å†™å…¥æƒé™ï¼š
      // 1. ç”¨æˆ·å¯ä»¥æ›´æ–°è‡ªå·±çš„æŸäº›å­—æ®µï¼ˆä½†ä¸èƒ½ä¿®æ”¹å…³é”®å­—æ®µï¼‰
      // 2. Cloud Functions (Admin SDK) ä¼šè‡ªåŠ¨ç»•è¿‡è¿™äº›è§„åˆ™
      allow update: if isSignedIn() && (
        request.auth.uid == resource.data.authUid ||
        request.auth.uid == resource.data.authId
      ) && (
        // åªå…è®¸æ›´æ–°ç‰¹å®šå­—æ®µï¼Œä¸èƒ½ä¿®æ”¹å…³é”®å­—æ®µ
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['roles', 'authUid', 'authId'])
      );
      
      // ğŸ”¥ åˆ›å»ºå’Œåˆ é™¤ï¼šåªå…è®¸ Cloud Functionsï¼ˆAdmin SDK ä¼šç»•è¿‡è§„åˆ™ï¼‰
      allow create, delete: if false; // å‰ç«¯ä¸èƒ½ç›´æ¥åˆ›å»ºæˆ–åˆ é™¤ç”¨æˆ·
    }
    
    // ==========================================
    // ç»„ç»‡åŸºæœ¬ä¿¡æ¯
    // ==========================================
    match /organizations/{orgId} {
      // ğŸ”¥ å…¬å¼€è¯»å–ï¼šä»»ä½•äººéƒ½å¯ä»¥è¯»å–ç»„ç»‡åŸºæœ¬ä¿¡æ¯
      allow read: if true;
      
      // ğŸ”¥ å†™å…¥ï¼šåªå…è®¸ Cloud Functionsï¼ˆAdmin SDKï¼‰
      allow write: if false;
    }
    
    // ==========================================
    // æ´»åŠ¨åŸºæœ¬ä¿¡æ¯
    // ==========================================
    match /organizations/{orgId}/events/{eventId} {
      // ğŸ”¥ å…¬å¼€è¯»å–ï¼šä»»ä½•äººéƒ½å¯ä»¥è¯»å–æ´»åŠ¨åŸºæœ¬ä¿¡æ¯
      allow read: if true;
      
      // ğŸ”¥ å†™å…¥ï¼šåªå…è®¸ Cloud Functionsï¼ˆAdmin SDKï¼‰
      allow write: if false;
      
      // å­é›†åˆï¼šæ´»åŠ¨ä¸‹çš„å…¶ä»–æ•°æ®
      match /{subcollection}/{document=**} {
        // é»˜è®¤æ‹’ç»ï¼Œç”±å…·ä½“è§„åˆ™å¤„ç†
        allow read, write: if false;
      }
    }
    
    // ==========================================
    // ç®¡ç†å‘˜é›†åˆ
    // ==========================================
    match /managers/{managerId} {
      // ğŸ”¥ å·²ç™»å½•ç”¨æˆ·å¯ä»¥è¯»å–ç®¡ç†å‘˜åˆ—è¡¨
      allow read: if isSignedIn();
      
      // ğŸ”¥ å†™å…¥ï¼šåªå…è®¸ Cloud Functions
      allow write: if false;
    }
    
    // ==========================================
    // OTP ä¼šè¯ï¼ˆä¸´æ—¶éªŒè¯ç ï¼‰
    // ==========================================
    match /otp_sessions/{sessionId} {
      // ğŸ”¥ å®Œå…¨ç”± Cloud Functions ç®¡ç†
      allow read, write: if false;
    }
    
    // ==========================================
    // è¯Šæ–­æµ‹è¯•é›†åˆï¼ˆå¯é€‰ï¼Œç”¨äºæµ‹è¯•è¿æ¥ï¼‰
    // ==========================================
    match /_diagnostic_test/{document=**} {
      // ğŸ”¥ å…è®¸å·²ç™»å½•ç”¨æˆ·è¯»å–ï¼ˆç”¨äºè¯Šæ–­å·¥å…·ï¼‰
      allow read: if isSignedIn();
      allow write: if false;
    }
    
    // ==========================================
    // é»˜è®¤è§„åˆ™ï¼šæ‹’ç»æ‰€æœ‰å…¶ä»–è®¿é—®
    // ==========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

// ==========================================
// ğŸ“ è§„åˆ™è¯´æ˜å’Œæ³¨æ„äº‹é¡¹
// ==========================================

/*
1. Cloud Functions ä½¿ç”¨ Admin SDKï¼š
   - Admin SDK ä¼š**å®Œå…¨ç»•è¿‡**æ‰€æœ‰ Firestore å®‰å…¨è§„åˆ™
   - å› æ­¤ Cloud Functions å¯ä»¥è¯»å†™ä»»ä½•æ•°æ®
   - å®¢æˆ·ç«¯è§„åˆ™åªå½±å“å‰ç«¯ç›´æ¥è®¿é—® Firestore çš„è¡Œä¸º

2. è®¤è¯æµç¨‹ï¼š
   - ç”¨æˆ·é€šè¿‡ Cloud Function ç™»å½•
   - Cloud Function åˆ›å»º custom token
   - å‰ç«¯ä½¿ç”¨ custom token ç™»å½• Firebase Auth
   - å‰ç«¯ä½¿ç”¨è®¤è¯åçš„ uid è¯»å–è‡ªå·±çš„ç”¨æˆ·æ•°æ®

3. authUid å­—æ®µï¼š
   - å¿…é¡»ç¡®ä¿ Firestore ä¸­çš„ç”¨æˆ·æ–‡æ¡£æœ‰ authUid å­—æ®µ
   - authUid åº”è¯¥ä¸ Firebase Auth çš„ uid åŒ¹é…
   - æ ¼å¼ï¼šphone_60{æ‰‹æœºå·}ï¼ˆä¾‹å¦‚ï¼šphone_60123456789ï¼‰

4. æµ‹è¯•è§„åˆ™ï¼š
   - ä½¿ç”¨ Firebase Console çš„ Rules Playground
   - æˆ–ä½¿ç”¨ Firebase Emulator æœ¬åœ°æµ‹è¯•
   - ç¡®ä¿è§„åˆ™ç¬¦åˆä½ çš„å®‰å…¨éœ€æ±‚

5. å¸¸è§é—®é¢˜ï¼š
   - å¦‚æœè¯»å–å¤±è´¥ï¼Œæ£€æŸ¥ authUid æ˜¯å¦æ­£ç¡®è®¾ç½®
   - å¦‚æœå†™å…¥å¤±è´¥ï¼Œç¡®è®¤æ˜¯å¦åº”è¯¥ç”± Cloud Functions å¤„ç†
   - æŸ¥çœ‹ Firebase Console çš„å®¡è®¡æ—¥å¿—äº†è§£è¢«æ‹’ç»çš„è¯·æ±‚
*/