{
  "firestoreArchitecture": {
    "description": "MyBazaar 慈善义卖管理系统 - Firestore 数据架构（完全正确版）",
    "version":"2025-12-08-v4",
    "lastUpdated": "2025-12-08",
    "architectureChanges": {
      "version_2025-12-08-v3": [
      "version_2025-12-08-v4": [
        "完全移除 Event.contactPerson 字段",
        "Event Manager 本身就是活动联络人，其 basicInfo 即为对外联络信息",
        "users.identityInfo 新增 position 字段（职位）",
        "Organization.contact 在创建组织时填写（组织主要联系人）",
        "创建 Event 时同时创建 Event Manager（活动负责人即联络人）",
        "简化架构：不需要额外的 contactPerson 或 contactPersons 数组"
        "Event 文档中完全移除 contactPerson，Event Manager 本身就是活动联络人",
        "Event Manager 从 Event.eventManager 对象移到 users 集合",
        "Event 文档中移除 eventManager 对象，改为 contactPerson（纯联络用途）",
        "Event Manager 成为 users 集合中的特殊角色，与 Finance Manager 形成制衡",
        "Event Manager 不分配点数，纯监控所有人员数据",
        "删除 Event 级别的 pointAllocations 集合",
        "Seller Manager 只管理 students，只能单人分配",
        "Platform Admin 创建 Event 时手动输入 contactPerson 信息"
      ],
      "version_2025-11-28-v2": [
        "修正 Event 集合路径：从顶级集合改为 Organization 的子集合",
        "修正所有子集合路径：users, pointAllocations, departmentStats 等都在 Event 下",
        "完整路径示例：organizations/{orgId}/events/{eventId}/users/{userId}",
        "添加 admin_uids 集合，明确 Platform Admin 存储位置",
        "Organization 集合：删除 adminUsers 字段，添加 contact 联系人信息",
        "Event.eventManager：从 admins 数组改为单个对象，包含详细信息和登录密码",
        "删除 GlobalUsers 集合，简化架构（用户只参与单个 Event）",
        "明确三层权限架构：Platform Admin -> Organization -> Event (Event Manager)"
      ]
    },
    "keyArchitecturePrinciples": {
      "hierarchicalStructure": "organizations/{orgId}/events/{eventId}/users/{userId}",
      "dataIsolation": "每个 Organization 的数据完全隔离",
      "eventManager": "每个 Event 只有一个 Event Manager，存储在 users 集合中，通过 roles 识别",
      "contactPerson": "Event Manager 本身就是活动联络人，无需额外的 contactPerson 字段",
      "subcollections": "users, departmentStats, sellerManagerStats 等都是 Event 的子集合"
    },
    "collections": {
      "admin_uids": {
        "path": "admin_uids/{adminUid}",
        "description": "平台管理员（Platform Admin）信息",
        "level": "Platform",
        "documentStructure": {
          "adminUid": "string (Platform Admin的认证UID，文档ID)",
          "email": "string (邮箱)",
          "phoneNumber": "string (电话号码)",
          "displayName": "string (显示名称，可选)",
          "role": "string (固定值：'platformAdmin')",
          "isActive": "boolean (是否激活)",
          "permissions": "array (权限列表，可选)",
          "createdAt": "timestamp (创建时间)",
          "lastLoginAt": "timestamp (最后登录时间)"
        },
        "indexes": [
          "email",
          "isActive"
        ],
        "securityRules": "只有已认证的Platform Admin可以读取；创建和修改需要超级管理员权限"
      },
      "organizations": {
        "path": "organizations/{organizationId}",
        "description": "组织（学校）基本信息",
        "level": "Organization",
        "documentStructure": {
          "organizationId": "string (自动生成的文档ID)",
          "orgCode": "string (组织代码，如 'chhs')",
          "orgName": {
            "zh-CN": "string (中文名称)",
            "en-US": "string (英文名称，可选)"
          },
          "orgType": "string ('school' | 'community' | 'company')",
          "address": {
            "street": "string",
            "city": "string",
            "state": "string",
            "postcode": "string",
            "country": "string (默认 'Malaysia')"
          },
          "contactInfo": {
            "phone": "string (机构电话)",
            "email": "string (机构邮箱)",
            "website": "string (可选)"
          },
          "contact": {
            "name": "string (联系人姓名)",
            "phone": "string (联系电话)",
            "email": "string (联系邮箱)",
            "position": "string (职位，如'校长'、'主任')"
          },
          "identityTags": [
            {
              "id": "string (标签ID，如 'student')",
              "name": {
                "zh-CN": "string (中文名，如 '学生')",
                "en-US": "string (英文名，如 'Student')"
              },
              "isActive": "boolean (是否激活)",
              "displayOrder": "number (显示顺序)"
            }
          ],
          "departments": [
            {
              "id": "string (部门ID，如 'J1A')",
              "name": "string (部门名称，如 '一年级A班')",
              "isActive": "boolean (是否激活)",
              "userCount": "number (部门用户数)",
              "displayOrder": "number (显示顺序)",
              "createdBy": "string ('system' | 'manual')",
              "createdAt": "timestamp"
            }
          ],
          "settings": {
            "defaultLanguage": "string (默认 'zh-CN')",
            "timezone": "string (默认 'Asia/Kuala_Lumpur')",
            "currency": "string (默认 'MYR')"
          },
          "statistics": {
            "totalEvents": "number (总活动数)",
            "activeEvents": "number (进行中活动数)",
            "totalUsers": "number (总用户数)",
            "lastUpdated": "timestamp"
          },
          "status": "string ('active' | 'inactive' | 'suspended')",
          "createdAt": "timestamp",
          "updatedAt": "timestamp",
          "createdBy": "string (Platform Admin UID)"
        },
        "indexes": [
          "orgCode",
          "status"
        ],
        "securityRules": "只有 Platform Admin 可以创建/修改组织信息",
        "subcollections": {
          "events": {
            "path": "organizations/{organizationId}/events/{eventId}",
            "description": "义卖活动信息（Organization 的子集合）",
            "level": "Event",
            "documentStructure": {
              "eventId": "string (自动生成的文档ID)",
              "eventCode": "string (活动代码，如 'ban')",
              "orgCode": "string (组织代码，冗余字段用于查询)",
              "eventName": {
                "zh-CN": "string (中文名称)",
                "en-US": "string (英文名称，可选)"
              },
              "eventInfo": {
                "description": "string (活动描述)",
                "fairDate": "timestamp (市集日期)",
                "consumptionPeriod": {
                  "startDate": "timestamp (消费开始日期)",
                  "endDate": "timestamp (消费结束日期)"
                }
              },
              "globalPointsStats": {
                "description": "全局点数统计（实时维护）",
                "totalAllocated": "number (累计分配的点数总额)",
                "currentCirculation": "number (当前流通中的点数)",
                "totalSold": "number (累计售出点数)",
                "totalRevenue": "number (累计销售额 RM，1:1比例)",
                "totalCollected": "number (累计已收款项 RM)",
                "pendingCollection": "number (待收款项 RM)",
                "collectionRate": "number (收款率，0-1之间)",
                "lastUpdated": "timestamp",
                "lastCalculated": "timestamp (上次完整计算时间)"
              },
              "roleStats": {
                "description": "各角色统计信息",
                "eventManagers": {
                  "count": "number (Event Manager 数量，固定为1)"
                },
                "sellerManagers": {
                  "count": "number (Seller Manager 数量)",
                  "totalAllocations": "number (累计分配次数)",
                  "totalPointsAllocated": "number (累计分配点数)",
                  "averageCollectionRate": "number (平均收款率)"
                },
                "sellers": {
                  "count": "number (Seller 总数)",
                  "activeCount": "number (有交易记录的 Seller 数)",
                  "totalRevenue": "number (累计销售额)"
                },
                "merchants": {
                  "count": "number (Merchant 总数)",
                  "activeCount": "number (有交易记录的 Merchant 数)",
                  "totalRevenue": "number (累计销售额)"
                },
                "customers": {
                  "count": "number (Customer 总数)",
                  "activeCount": "number (有交易记录的 Customer 数)",
                  "totalSpent": "number (累计消费额)"
                }
              },
              "departmentOverview": {
                "description": "部门概览统计",
                "totalDepartments": "number (部门总数)",
                "topPerformers": [
                  {
                    "departmentCode": "string",
                    "departmentName": "string",
                    "totalRevenue": "number",
                    "collectionRate": "number"
                  }
                ],
                "lowestCollectionRate": {
                  "departmentCode": "string",
                  "departmentName": "string",
                  "collectionRate": "number"
                }
              },
              "statistics": {
                "totalUsers": "number (总用户数)",
                "totalManagers": "number (管理员总数)",
                "totalSellers": "number (Seller 总数)",
                "totalMerchants": "number (Merchant 总数)",
                "totalCustomers": "number (Customer 总数)",
                "lastUpdated": "timestamp"
              },
              "cashCollections": {
                "description": "现金收款统计",
                "totalSubmitted": "number (累计上交现金 RM)",
                "totalVerified": "number (累计验证现金 RM)",
                "pendingVerification": "number (待验证现金 RM)",
                "lastUpdated": "timestamp"
              },
              "status": "string ('planning' | 'active' | 'completed' | 'cancelled')",
              "createdAt": "timestamp",
              "updatedAt": "timestamp",
              "createdBy": "string (Platform Admin UID)"
            },
            "indexes": [
              "orgCode",
              "eventCode",
              "status",
              "eventInfo.fairDate"
            ],
            "securityRules": "Platform Admin 可以创建活动；Event Manager 可以管理活动内容",
            "subcollections": {
              "users": {
                "path": "organizations/{organizationId}/events/{eventId}/users/{userId}",
                "description": "活动参与者信息（Event 的子集合）",
                "documentStructure": {
                  "userId": "string (Firebase Auth UID，文档ID)",
                  "authUid": "string (认证UID，与userId相同)",
                  "roles": [
                    "string ( 'sellerManager' | 'merchantManager' | 'customerManager' | 'financeManager' | 'seller' | 'merchant' | 'customer')"
                  ],
                  "identityTag": "string ('student' | 'teacher' | 'parent' | 'staff' | 'volunteer' | 'external')",
                  "identityInfo": {
                    "identityId": "string (身份编号，如学号、工号)",
                    "identityTag": "string (身份标签)",
                    "identityName": "string (身份名称)",
                    "department": "string (部门代码)",
                    "position": "string (职位，如 '活动负责人'、'班主任'，可选)"
                  },
                  "basicInfo": {
                    "phoneNumber": "string (电话号码)",
                    "englishName": "string (英文名)",
                    "chineseName": "string (中文名)",
                    "email": "string (邮箱，可选)",
                    "passwordHash": "string (密码哈希)",
                    "passwordSalt": "string (密码盐值)",
                    "isPhoneVerified": "boolean (电话是否验证)"
                  },
                  "pointsStats": {
                    "description": "点数统计（实时维护，主要用于 seller 角色）",
                    "totalReceived": "number (累计收到的点数)",
                    "currentBalance": "number (当前拥有点数/库存)",
                    "totalSold": "number (累计已售出点数)",
                    "totalRevenue": "number (累计销售额 RM)",
                    "totalCollected": "number (累计已收款 RM)",
                    "pendingCollection": "number (待收款 RM)",
                    "collectionRate": "number (个人收款率，0-1之间)",
                    "receivedFromEventManager": "number (从 Event Manager 获得的点数)",
                    "receivedFromSellerManager": "number (从 Seller Manager 获得的点数)",
                    "lastReceived": "timestamp (最后一次收到点数)",
                    "lastSold": "timestamp (最后一次销售)",
                    "lastCollected": "timestamp (最后一次收款)",
                    "lastUpdated": "timestamp"
                  },
                  "seller": {
                    "availablePoints": "number (当前可用点数余额)",
                    "totalPointsSold": "number (累计售出点数)",
                    "totalRevenue": "number (累计销售额 RM)",
                    "totalCashCollected": "number (累计已收现金)",
                    "pendingCollection": "number (待收款金额)",
                    "transactions": "object (交易记录)",
                    "collectionAlert": {
                      "hasWarning": "boolean (是否有收款警示)",
                      "warningLevel": "string ('none' | 'low' | 'medium' | 'high')",
                      "pendingAmount": "number (待收款金额)",
                      "pendingRatio": "number (待收款比例 0-1)"
                    }
                  },
                  "merchant": {
                    "availablePoints": "number",
                    "totalPointsReceived": "number",
                    "totalSpent": "number",
                    "transactions": "object"
                  },
                  "customer": {
                    "availablePoints": "number",
                    "totalPointsReceived": "number",
                    "totalSpent": "number",
                    "transactions": "object"
                  },
                  "eventManager": {
                    "description": "Event Manager 角色专用数据",
                    "permissions": {
                      "canManageUsers": "boolean (可以创建、编辑、删除用户)",
                      "canManageRoles": "boolean (可以分配角色给用户)",
                      "canAssignManagers": "boolean (可以指派 Seller Manager、Finance Manager)",
                      "canViewAllData": "boolean (可以查看所有数据)",
                      "canMonitorAll": "boolean (可以监控所有人员活动)",
                      "canModifyEventSettings": "boolean (可以修改活动设置)"
                    },
                    "restrictions": {
                      "cannotAllocatePoints": "boolean (不能分配点数)",
                      "cannotModifyOwnRoles": "boolean (不能修改自己的角色)",
                      "cannotDeleteSelf": "boolean (不能删除自己)",
                      "cannotHoldOtherRoles": "boolean (不能兼任其他角色)"
                    },
                    "monitoringScope": {
                      "canMonitorFinanceManager": "boolean (可以监控 Finance Manager 的点数分配)",
                      "canMonitorSellerManager": "boolean (可以监控 Seller Manager 的收款活动)",
                      "canMonitorAllTransactions": "boolean (可以查看所有交易记录)",
                      "canViewAllStats": "boolean (可以查看所有统计数据)"
                    },
                    "notes": "Event Manager 纯监控角色，不参与点数分配和现金流；与 Finance Manager 形成制衡；每个 Event 只有一个 Event Manager"
                  },
                  "sellerManager": {
                    "description": "Seller Manager 角色专用数据",
                    "totalAllocations": "number (累计分配次数)",
                    "totalPointsAllocated": "number (累计分配点数)",
                    "managedDepartments": [
                      "string (管理的部门代码数组，如 ['J1A', 'J1B'])"
                    ],
                    "managedIdentityTags": [
                      "student"
                    ],
                    "permissions": {
                      "canAllocatePoints": true,
                      "canCollectCash": true,
                      "canViewDepartmentStats": true,
                      "canBatchAllocate": false
                    },
                    "notes": "Seller Manager 只管理 students，不管理 teacher/staff",
                    "alerts": {
                      "lowCollectionRate": [
                        "string (低收款率警示的用户ID列表)"
                      ]
                    },
                    "lastAllocationAt": "timestamp"
                  },
                  "financeManager": {
                    "managedIdentityTags": [
                      "teacher",
                      "staff",
                      "parent",
                      "...其他非學生身份"
                    ],
                    "permissions": {
                      "canAllocateToIndividual": true,
                      "canBatchAllocate": false,
                      "canReceiveCash": true,
                      "canVerifySubmissions": true,
                      "canViewAllStats": true
                    },
                    "batchAllocationLimit": 0,
                    "notes": "所有 FM 都可單人分配；批量分配需特別開啟權限"
                  },
                  "cashSubmissions (subcollection)": {
                    "description": "现金上交记录 - Subcollection to track cash submissions from sellers to managers",
                    "<submissionId>": {
                      "amount": "number",
                      "submittedBy": "userId (seller)",
                      "submittedTo": "sellerManager | financeManager",
                      "submittedToUserId": "string",
                      "note": "string",
                      "timestamp": "timestamp",
                      "verifiedBy": "string (optional)",
                      "verifiedAt": "timestamp (optional)",
                      "status": "pending | verified | disputed (optional)"
                    }
                  },
                  "accountStatus": {
                    "isActive": "boolean (账户是否激活)",
                    "isSuspended": "boolean (是否被暂停)",
                    "suspensionReason": "string (暂停原因，可选)",
                    "lastLoginAt": "timestamp"
                  },
                  "activityData": {
                    "lastActiveAt": "timestamp",
                    "totalLogins": "number",
                    "createdAt": "timestamp",
                    "updatedAt": "timestamp",
                    "createdBy": "string (创建者UID)"
                  }
                },
                "indexes": [
                  "roles",
                  "identityTag",
                  "identityInfo.department",
                  "accountStatus.isActive"
                ],
                "securityRules": "用户可以读取自己的数据；Event Manager 可以读取所有用户；Seller Manager 可以读取 managedDepartments 内的用户",
                "subcollections": {
                  "pointAllocations": {
                    "path": "organizations/{organizationId}/events/{eventId}/users/{sellerManagerId}/pointAllocations/{allocationId}",
                    "description": "Seller Manager 的点数分配记录（仅 sellerManager 角色有此子集合）",
                    "documentStructure": {
                      "allocationId": "string (分配记录ID)",
                      "fromUserId": "string (Seller Manager的userId)",
                      "toUserId": "string (接收者的userId)",
                      "toDepartment": "string (接收者的部门)",
                      "points": "number (分配的点数)",
                      "reason": "string (分配原因，可选)",
                      "allocatedAt": "timestamp",
                      "status": "string ('completed' | 'cancelled')"
                    },
                    "indexes": [
                      "toUserId",
                      "allocatedAt"
                    ]
                  }
                }
              },
              "departmentStats": {
                "path": "organizations/{organizationId}/events/{eventId}/departmentStats/{departmentCode}",
                "description": "部门统计信息（按部门聚合）",
                "documentStructure": {
                  "departmentCode": "string (部门代码)",
                  "departmentName": "string (部门名称)",
                  "totalUsers": "number (部门总用户数)",
                  "totalSellers": "number (Seller 数量)",
                  "activeSellers": "number (有交易的 Seller 数)",
                  "pointsStats": {
                    "totalReceived": "number (部门累计收到点数)",
                    "currentBalance": "number (部门当前点数余额)",
                    "totalSold": "number (部门累计售出点数)",
                    "totalRevenue": "number (部门累计销售额 RM)",
                    "totalCollected": "number (部门累计已收款 RM)",
                    "pendingCollection": "number (部门待收款 RM)",
                    "collectionRate": "number (部门收款率，0-1之间)"
                  },
                  "collectionAlerts": {
                    "count": "number (有收款警示的用户数)",
                    "userIds": [
                      "string (有警示的用户ID列表)"
                    ]
                  },
                  "topPerformers": [
                    {
                      "userId": "string",
                      "displayName": "string",
                      "totalRevenue": "number",
                      "collectionRate": "number"
                    }
                  ],
                  "lastUpdated": "timestamp",
                  "lastCalculated": "timestamp"
                },
                "indexes": [
                  "departmentCode",
                  "pointsStats.totalRevenue"
                ]
              },
              "sellerManagerStats": {
                "path": "organizations/{organizationId}/events/{eventId}/sellerManagerStats/{sellerManagerId}",
                "description": "Seller Manager 的统计信息（managedDepartments 存储在 users/{userId}/roleSpecificData/sellerManager 中）",
                "documentStructure": {
                  "sellerManagerId": "string (Seller Manager的userId)",
                  "displayName": "string",
                  "managedUsersCount": "number (管理的用户总数)",
                  "totalAllocations": "number (累计分配次数)",
                  "totalPointsAllocated": "number (累计分配点数)",
                  "managedPointsStats": {
                    "description": "管理范围内的点数统计",
                    "totalReceived": "number (管理范围内用户累计收到点数)",
                    "currentBalance": "number (管理范围内用户当前点数余额)",
                    "totalSold": "number (管理范围内用户累计售出点数)",
                    "totalRevenue": "number (管理范围内累计销售额)",
                    "totalCollected": "number (管理范围内累计已收款)",
                    "pendingCollection": "number (管理范围内待收款)",
                    "collectionRate": "number (管理范围内收款率)"
                  },
                  "alerts": {
                    "lowCollectionRateCount": "number (低收款率警示用户数)",
                    "lowCollectionRateUsers": [
                      {
                        "userId": "string",
                        "displayName": "string",
                        "department": "string",
                        "collectionRate": "number",
                        "pendingCollection": "number"
                      }
                    ]
                  },
                  "departmentBreakdown": [
                    {
                      "departmentCode": "string",
                      "departmentName": "string",
                      "userCount": "number",
                      "totalRevenue": "number",
                      "collectionRate": "number"
                    }
                  ],
                  "lastUpdated": "timestamp",
                  "lastCalculated": "timestamp"
                },
                "indexes": [
                  "sellerManagerId"
                ]
              },
              "transactions": {
                "path": "organizations/{organizationId}/events/{eventId}/transactions/{transactionId}",
                "description": "交易记录（Seller/Merchant 售出点数给 Customer）",
                "documentStructure": {
                  "transactionId": "string (交易ID)",
                  "type": "string ('sale' | 'refund')",
                  "sellerId": "string (卖家userId，Seller或Merchant)",
                  "sellerRole": "string ('seller' | 'merchant')",
                  "sellerName": "string (卖家名称)",
                  "sellerDepartment": "string (卖家部门)",
                  "customerId": "string (买家userId)",
                  "customerName": "string (买家名称)",
                  "points": "number (交易点数)",
                  "amount": "number (交易金额 RM，1:1比例)",
                  "collectionStatus": "string ('collected' | 'pending')",
                  "collectedAmount": "number (已收款金额)",
                  "collectedAt": "timestamp (收款时间，可选)",
                  "transactionAt": "timestamp (交易时间)",
                  "remarks": "string (备注，可选)"
                },
                "indexes": [
                  "sellerId",
                  "customerId",
                  "transactionAt",
                  "collectionStatus"
                ]
              },
              "cashCollections": {
                "path": "organizations/{organizationId}/events/{eventId}/cashCollections/{collectionId}",
                "description": "现金收款记录（Seller Manager 从 Seller 收取现金的记录）",
                "level": "Event Subcollection",
                "documentStructure": {
                  "collectionId": "string (文档ID)",
                  "type": "string ('sellerToManager')",
                  "collectedBy": "string (Seller Manager ID)",
                  "collectedByName": "string",
                  "collectedByRole": "string ('sellerManager')",
                  "collectedByDepartment": "string",
                  "submittedBy": "string (Seller ID)",
                  "submittedByName": "string",
                  "submittedByRole": "string ('seller')",
                  "submittedByDepartment": "string",
                  "amount": "number",
                  "pointsValue": "number",
                  "discrepancy": "number",
                  "discrepancyReason": "string",
                  "discrepancyType": "string",
                  "status": "string",
                  "collectedAt": "timestamp",
                  "submittedAt": "timestamp",
                  "confirmedAt": "timestamp",
                  "submissionId": "string",
                  "sellerId": "string",
                  "sellerDepartment": "string",
                  "eventId": "string",
                  "organizationId": "string",
                  "note": "string",
                  "createdAt": "timestamp",
                  "updatedAt": "timestamp"
                },
                "indexes": [
                  "collectedBy",
                  "collectedAt",
                  "sellerId",
                  "status"
                ],
                "securityRules": "Seller Manager 可读写自己的记录; Finance Manager 和 Event Manager 可读所有记录"
              },
              "cashSubmissions": {
                "path": "organizations/{organizationId}/events/{eventId}/cashSubmissions/{submissionId}",
                "description": "现金上交记录（Seller Manager 批量上交给 Finance Manager 的记录）",
                "level": "Event Subcollection",
                "documentStructure": {
                  "submissionId": "string (文档ID)",
                  "type": "string ('managerToFinance')",
                  "submittedBy": "string (Seller Manager ID)",
                  "submittedByName": "string",
                  "submittedByRole": "string ('sellerManager')",
                  "submittedByDepartments": "array<string>",
                  "receivedBy": "string (Finance Manager ID)",
                  "receivedByName": "string",
                  "receivedByRole": "string ('financeManager')",
                  "totalAmount": "number",
                  "collectionCount": "number",
                  "includedCollections": "array<string>",
                  "breakdown": {
                    "normalCollections": "number",
                    "partialCollections": "number",
                    "pointsRecovery": "number",
                    "waivers": "number",
                    "totalDiscrepancy": "number"
                  },
                  "status": "string ('pending' | 'confirmed' | 'rejected')",
                  "submittedAt": "timestamp",
                  "confirmedAt": "timestamp",
                  "rejectedAt": "timestamp",
                  "rejectionReason": "string",
                  "eventId": "string",
                  "organizationId": "string",
                  "note": "string",
                  "financeNote": "string",
                  "createdAt": "timestamp",
                  "updatedAt": "timestamp"
                },
                "indexes": [
                  "submittedBy",
                  "submittedAt",
                  "status",
                  "receivedBy"
                ],
                "securityRules": "Seller Manager 可创建和读取自己的记录; Finance Manager 可读写所有记录; Event Manager 可读所有记录"
              },
              "departments": {
                "path": "organizations/{organizationId}/events/{eventId}/departments/{departmentCode}",
                "description": "活动中的部门元数据（与 Organization.departments 同步，但允许Event级别的自定义）",
                "documentStructure": {
                  "departmentCode": "string (部门代码)",
                  "departmentName": "string (部门名称)",
                  "isActive": "boolean (是否激活)",
                  "userCount": "number (该部门的用户数)",
                  "createdBy": "string ('system' | 'manual')",
                  "createdAt": "timestamp",
                  "updatedAt": "timestamp"
                },
                "indexes": [
                  "departmentCode",
                  "isActive"
                ]
              }
            }
          }
        }
      },
      "otp_sessions": {
        "path": "otp_sessions/{sessionId}",
        "description": "OTP 验证会话（临时数据，用于登录验证）",
        "level": "Platform",
        "documentStructure": {
          "sessionId": "string (会话ID)",
          "phoneNumber": "string (手机号)",
          "orgCode": "string (组织代码)",
          "eventCode": "string (活动代码)",
          "otpCodeHash": "string (OTP哈希值)",
          "expiresAt": "number (过期时间戳)",
          "attempts": "number (尝试次数)",
          "createdAt": "timestamp",
          "devMode": "boolean (是否为开发模式)"
        },
        "indexes": [
          "phoneNumber",
          "expiresAt"
        ],
        "securityRules": "只读；由 Cloud Functions 创建和管理"
      }
    },
    "cloudFunctions": {
      "description": "Cloud Functions 触发器设计",
      "functions": {
        "updateUserPointsStats": {
          "trigger": "organizations/{orgId}/events/{eventId}/users/{userId} onWrite",
          "description": "当用户点数变化时，更新相关统计",
          "tasks": [
            "计算用户的 pointsStats（实时统计）",
            "更新部门的 departmentStats",
            "更新 Event 的 globalPointsStats",
            "如果用户是 Seller，更新对应 SellerManager 的 stats",
            "检查是否需要触发收款警示"
          ],
          "relatedFiles": [
            "functions/userStatsFunctions.js"
          ]
        },
        "onSellerManagerAllocation": {
          "trigger": "organizations/{orgId}/events/{eventId}/users/{sellerManagerId}/pointAllocations/{allocationId} onCreate",
          "description": "当 Seller Manager 分配点数时",
          "scope": "只能分配給 identityTag 為 student 的用戶",
          "tasks": [
            "验证接收者的 identityTag 是否为 'student'",
            "验证分配额度是否超出 maxPerAllocation 限制",
            "更新接收者的 seller.availablePoints",
            "更新接收者的 pointsStats.totalReceived",
            "更新接收者的 pointsStats.receivedFromSellerManager",
            "更新部门的 departmentStats",
            "更新 SellerManager 的 sellerManagerStats",
            "更新 Event 的 globalPointsStats.totalAllocated",
            "计算并更新收款警示（仅对 students）"
          ],
          "relatedFiles": [
            "functions/sellerManagerFunctions.js"
          ]
        },
        "onFinanceManagerAllocation": {
          "trigger": "organizations/{orgId}/events/{eventId}/users/{financeManagerId}/pointAllocations/{allocationId} onCreate",
          "description": "当 Finance Manager 分配点数时（单人或批量）",
          "scope": "可分配給任何非 student 的 identityTag，如 teacher/staff/parent 等",
          "tasks": [
            "验证 Finance Manager 是否有 canAllocateToIndividual 权限",
            "如果是批量分配，验证 canBatchAllocate 权限",
            "验证批量分配额度是否超出 batchAllocationLimit",
            "验证接收者的 identityTag 不是 'student'",
            "更新接收者的对应角色 availablePoints（seller/merchant/customer）",
            "更新接收者的 pointsStats.totalReceived",
            "更新接收者的 pointsStats.receivedFromFinanceManager",
            "更新 FinanceManager 的 financeManagerStats",
            "更新 Event 的 globalPointsStats.totalAllocated",
            "不计算收款警示（非 students 不需要）"
          ],
          "relatedFiles": [
            "functions/financeManagerFunctions.js"
          ]
        },
        "onTransaction": {
          "trigger": "organizations/{orgId}/events/{eventId}/transactions/{transactionId} onCreate",
          "description": "当交易发生时，更新统计",
          "tasks": [
            "验证 Seller 有足够的点数余额",
            "更新 Seller 的 seller.availablePoints（减少）",
            "更新 Seller 的 seller.totalPointsSold（增加）",
            "更新 Seller 的 seller.totalRevenue（增加）",
            "更新 Seller 的 seller.pendingCollection（增加待收款）",
            "更新 Customer/Merchant 的 availablePoints（增加）",
            "更新部门的 departmentStats",
            "更新 Event 的 globalPointsStats.totalSold",
            "更新 Event 的 globalPointsStats.totalRevenue",
            "检查并更新收款警示"
          ],
          "relatedFiles": [
            "functions/transactionFunctions.js"
          ]
        },
        "onCashSubmission": {
          "trigger": "organizations/{orgId}/events/{eventId}/cashSubmissions/{submissionId} onCreate",
          "description": "当现金上交记录创建时（SM 上交给 FM）",
          "tasks": [
            "验证 Seller Manager 的上交金额",
            "更新 Seller Manager 的 sellerManagerStats（待上交金额减少）",
            "更新 Finance Manager 的 financeManagerStats（待验证金额增加）",
            "创建待验证记录",
            "发送通知给 Finance Manager"
          ],
          "relatedFiles": [
            "functions/cashSubmissionFunctions.js"
          ]
        },
        "onCashCollection": {
          "trigger": "organizations/{orgId}/events/{eventId}/cashCollections/{collectionId} onCreate",
          "description": "当现金收款记录创建时",
          "types": [
            "Seller Manager 从 Student 收款",
            "Finance Manager 直接从 Teacher/Staff 收款"
          ],
          "tasks": [
            "验证收款人权限（SM 或 FM）",
            "验证金额是否合理（不超过 pendingCollection）",
            "更新 Seller 的 seller.totalCashCollected",
            "更新 Seller 的 seller.pendingCollection（减少）",
            "更新收款人的统计（sellerManagerStats 或 financeManagerStats）",
            "更新部门的 departmentStats",
            "更新 Event 的 globalPointsStats.totalCollected",
            "更新收款警示状态"
          ],
          "relatedFiles": [
            "functions/cashCollectionFunctions.js"
          ]
        },
        "checkCollectionWarnings": {
          "trigger": "organizations/{orgId}/events/{eventId}/users/{userId} onUpdate",
          "description": "检查并更新收款警示",
          "scope": "仅对 identityTag 为 student 的用户",
          "tasks": [
            "验证用户是否为 student",
            "计算待收款比例",
            "根据 Event.pointAllocationRules.sellerManager.warningThreshold 判断",
            "更新用户的 seller.collectionAlert",
            "更新部门的 collectionAlerts",
            "更新 SellerManager 的 alerts",
            "如果达到高风险级别，发送通知"
          ],
          "relatedFiles": [
            "functions/collectionWarningFunctions.js"
          ]
        },
        "dailyStatsRecalculation": {
          "trigger": "PubSub Schedule (每天凌晨2点)",
          "description": "定时重算所有统计数据，确保一致性",
          "tasks": [
            "遍历所有 Organization 的所有 Event",
            "重新计算 globalPointsStats",
            "重新计算所有 departmentStats",
            "重新计算所有 sellerManagerStats",
            "重新计算所有 financeManagerStats",
            "标记 lastCalculated 时间戳",
            "生成每日统计报告"
          ],
          "relatedFiles": [
            "functions/scheduledFunctions.js"
          ]
        }
      }
    },
    "securityRules": {
      "description": "Firestore Security Rules 概览",
      "principles": [
        "三层权限架构：Platform Admin（平台级）-> Organization（组织级）-> Event（活动级，由 Event Manager 管理）",
        "Platform Admin 权限：可以创建和管理所有 Organization；可以创建 Event 并指定 Event Manager",
        "Event Manager 权限：每个 Event 只有一个 Event Manager；只能管理自己负责的 Event 内的数据；不分配点数；不兼任其他角色；纯监控所有人员数据",
        "完全数据隔离：不同 Organization 和 Event 之间的数据完全隔离",
        "角色权限：基于用户角色（Platform Admin, Event Manager, Seller Manager, Seller, Merchant, Customer, Finance）控制访问",
        "所有权验证：用户只能访问自己的数据或管理范围内的数据",
        "Seller Manager 权限：只能管理 managedDepartments 内的用户数据",
        "统计数据保护：统计文档只能由系统（Cloud Functions）写入，用户只读"
      ],
      "ruleExamples": {
        "admin_uids": {
          "read": "已认证的 Platform Admin 可读",
          "write": "仅超级管理员权限（通过 Cloud Functions）"
        },
        "organizations": {
          "read": "Platform Admin 可以读取所有组织；Event Manager 可以读取自己所在组织",
          "write": "仅 Platform Admin 可以创建和修改组织信息"
        },
        "organizations/{orgId}/events": {
          "read": "Platform Admin 和对应的 Event Manager 可读",
          "write": "Platform Admin 可以创建 Event；Event Manager 可以修改自己管理的 Event"
        },
        "organizations/{orgId}/events/{eventId}/users": {
          "read": "用户可以读取自己的数据；Event Manager 可以读取所有用户；Seller Manager 可以读取 managedDepartments 内的用户",
          "write": "用户只能更新自己的基本信息；Event Manager 可以创建/更新用户；Seller Manager 可以更新管理范围内的用户"
        },
        "organizations/{orgId}/events/{eventId}/users/{eventManagerId}": {
          "read": "Event Manager 可以读取自己的数据；Platform Admin 可读；其他用户不可读",
          "write": "Platform Admin 可以创建/修改 Event Manager；Event Manager 不能修改自己的 roles；不能删除自己",
          "note": "Event Manager 通过 roles=['eventManager'] 识别，每个 Event 只能有一个"
        },
        "organizations/{orgId}/events/{eventId}/departmentStats": {
          "read": "Event Manager 和相关 Seller Manager 可读",
          "write": "仅 Cloud Functions 可写"
        },
        "organizations/{orgId}/events/{eventId}/transactions": {
          "read": "交易双方和 Event Manager 可读",
          "write": "Seller/Merchant 可以创建交易；Event Manager 可以修改交易"
        }
      }
    },
    "dataFlowExamples": {
      "platformAdminCreatesEvent": {
        "description": "Platform Admin 创建 Event 并指定 Event Manager",
        "steps": [
          "1. Platform Admin 在 frontend 输入 Event 基本信息",
          "2. Platform Admin 手动输入 contactPerson 信息（姓名、电话、邮箱、职位）",
          "3. Platform Admin 输入 Event Manager 的基本信息（姓名、电话、密码等）",
          "4. Frontend 调用 Cloud Function: createEvent",
          "5. Cloud Function 创建 Event 文档（包含 contactPerson）",
          "6. Cloud Function 在 users 集合中创建 Event Manager 文档：",
          "   organizations/{orgId}/events/{eventId}/users/{eventManagerId}",
          "7. Event Manager 文档包含：",
          "   - roles: ['eventManager']",
          "   - eventManager: { permissions, restrictions, monitoringScope }",
          "   - basicInfo: { 姓名、电话、邮箱等 }",
          "8. Cloud Function 为 Event Manager 生成登录凭证",
          "9. 返回成功，Platform Admin 可以通知 Event Manager 登录信息"
        ],
        "note": "contactPerson 与 Event Manager 可以是同一人，也可以是不同人"
      },
      "sellerManagerAllocatesPoints": {
        "description": "Seller Manager 分配点数给部门内的 Seller",
        "steps": [
          "1. Seller Manager 在 frontend 输入分配信息",
          "2. Frontend 调用 Cloud Function: allocatePointsBySellerManager",
          "3. Cloud Function 验证权限（检查 managedDepartments）",
          "4. Cloud Function 检查限额（pointAllocationRules.sellerManager.maxPerAllocation）",
          "5. Cloud Function 创建文档：organizations/{orgId}/events/{eventId}/users/{sellerManagerId}/pointAllocations/{allocationId}",
          "6. Firestore 触发器：onSellerManagerAllocation",
          "7. 更新接收者的 pointsStats",
          "8. 更新 departmentStats",
          "9. 更新 sellerManagerStats",
          "10. 检查收款警示"
        ]
      },
      "sellerSellsToCustomer": {
        "description": "Seller 售出点数给 Customer",
        "steps": [
          "1. Seller 在 frontend 扫描 Customer 二维码，输入点数",
          "2. Frontend 调用 Cloud Function: createTransaction",
          "3. Cloud Function 验证：Seller 有足够的点数余额（currentBalance）",
          "4. Cloud Function 创建交易：organizations/{orgId}/events/{eventId}/transactions/{transactionId}",
          "5. Firestore 触发器：onTransaction",
          "6. 更新 Seller 的 pointsStats（减少 currentBalance，增加 totalSold）",
          "7. 更新 Customer 的 customer.availablePoints（增加）",
          "8. 更新 departmentStats",
          "9. 更新 Event.globalPointsStats"
        ]
      }
    },
    "pathSummary": {
      "description": "完整路径参考",
      "topLevelCollections": [
        "admin_uids/{adminUid}",
        "organizations/{organizationId}",
        "otp_sessions/{sessionId}"
      ],
      "organizationSubcollections": [
        "organizations/{organizationId}/events/{eventId}"
      ],
      "eventSubcollections": [
        "organizations/{organizationId}/events/{eventId}/users/{userId}",
        "organizations/{organizationId}/events/{eventId}/departmentStats/{departmentCode}",
        "organizations/{organizationId}/events/{eventId}/sellerManagerStats/{sellerManagerId}",
        "organizations/{organizationId}/events/{eventId}/financeManagerStats/{financeManagerId}",
        "organizations/{organizationId}/events/{eventId}/transactions/{transactionId}",
        "organizations/{organizationId}/events/{eventId}/cashCollections/{collectionId}",
        "organizations/{organizationId}/events/{eventId}/cashSubmissions/{submissionId}",
        "organizations/{organizationId}/events/{eventId}/departments/{departmentCode}"
      ],
      "userSubcollections": [
        "organizations/{organizationId}/events/{eventId}/users/{sellerManagerId}/pointAllocations/{allocationId}",
        "organizations/{organizationId}/events/{eventId}/users/{financeManagerId}/pointAllocations/{allocationId}"
      ]
    }
  }
}