Ran terminal command: gcloud run services set-iam-policy loginwithpin --region=us-central1 --project=mybazaar-c4881 - <<EOF
bindings:
- members:
  - serviceAccount:1069326034581-compute@developer.gserviceaccount.com
  - serviceAccount:firebase-adminsdk-fbsvc@mybazaar-c4881.iam.gserviceaccount.com
  - user:weschen@mybazaar.my
  role: roles/run.invoker
etag: BwZBC1-l1y4=
EOF

å¥½çš„ï¼Œè®“æˆ‘æš«åœä¸¦ç¸½çµç›®å‰çš„æƒ…æ³å’Œå»ºè­°ï¼š

## ðŸ“Š å•é¡Œç¸½çµ

### ðŸ”´ æ ¸å¿ƒå•é¡Œ
**CORS éŒ¯èª¤æŒçºŒå­˜åœ¨**ï¼Œå› ç‚ºï¼š
1. Firebase Functions v2 (2nd Gen) éœ€è¦ Cloud Run IAM æ¬Šé™
2. æ‚¨çš„çµ„ç¹”æ”¿ç­–é˜»æ­¢å…¬é–‹è¨ªå•ï¼ˆ`allUsers` è¢«ç¦æ­¢ï¼‰
3. Callable å‡½æ•¸ç„¡æ³•è¢«ç€è¦½å™¨ç›´æŽ¥èª¿ç”¨ï¼Œå› ç‚ºç¼ºå°‘å¿…è¦çš„ IAM ç¶å®š

### ðŸ”§ å·²å˜—è©¦çš„æ–¹æ¡ˆ
âœ… ä½¿ç”¨ v2 `onCall` + `cors: true` - **å¤±æ•—**ï¼ˆIAM é˜»æ­¢ï¼‰
âœ… ä½¿ç”¨ v2 `onRequest` + æ‰‹å‹• CORS - **å¤±æ•—**ï¼ˆçµ„ç¹”æ”¿ç­–é˜»æ­¢ï¼‰
âœ… ä½¿ç”¨ v1 `onCall` - **ç„¡æ³•ä½¿ç”¨**ï¼ˆfirebase-functions v6 åªæ”¯æŒ v2ï¼‰
âœ… æ·»åŠ ç‰¹å®šæœå‹™è³¬è™Ÿåˆ° IAM - **éƒ¨åˆ†æˆåŠŸ**ï¼ˆä½†ç€è¦½å™¨è«‹æ±‚ä¸ä½¿ç”¨é€™äº›è³¬è™Ÿï¼‰

---

## ðŸ’¡ å¯è¡Œçš„è§£æ±ºæ–¹æ¡ˆ

### **æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ Firebase Hosting Rewriteï¼ˆæŽ¨è–¦ï¼‰**
**åŽŸç†**ï¼šè«‹æ±‚é€šéŽ Firebase Hosting è½‰ç™¼åˆ° Cloud Functionsï¼Œç¹žéŽ CORS é™åˆ¶

**æ­¥é©Ÿ**ï¼š
1. éƒ¨ç½²å‰ç«¯åˆ° Firebase Hosting
2. åœ¨ firebase.json æ·»åŠ  rewrite è¦å‰‡
3. ä½¿ç”¨ç›¸å°è·¯å¾‘èª¿ç”¨å‡½æ•¸ï¼ˆå¦‚ `/api/loginWithPin`ï¼‰

**å„ªé»ž**ï¼š
- âœ… å®Œå…¨é¿å… CORS å•é¡Œ
- âœ… ä¸éœ€è¦ä¿®æ”¹çµ„ç¹”æ”¿ç­–
- âœ… ç”Ÿç”¢ç’°å¢ƒä¹Ÿå¯ç”¨

**ç¼ºé»ž**ï¼š
- âš ï¸ éœ€è¦éƒ¨ç½²åˆ° Hostingï¼ˆä¸é©ç”¨æ–¼ localhost é–‹ç™¼ï¼‰

---

### **æ–¹æ¡ˆ 2ï¼šä½¿ç”¨æœ¬åœ° Functions Emulatorï¼ˆé–‹ç™¼ç’°å¢ƒï¼‰**
**åŽŸç†**ï¼šåœ¨æœ¬åœ°é‹è¡Œ Cloud Functions Emulatorï¼Œé¿å…é ç«¯ IAM é™åˆ¶

**æ­¥é©Ÿ**ï¼š
1. é‹è¡Œ `firebase emulators:start --only functions`
2. ä¿®æ”¹ firebase.js é€£æŽ¥åˆ° emulator
3. æœ¬åœ°é–‹ç™¼å®Œæˆå¾Œå†éƒ¨ç½²

**å„ªé»ž**ï¼š
- âœ… é–‹ç™¼ç’°å¢ƒä¸‹å®Œå…¨æ²’æœ‰ CORS å•é¡Œ
- âœ… ä¸éœ€è¦ç¶²çµ¡é€£æŽ¥
- âœ… å¿«é€Ÿæ¸¬è©¦

**ç¼ºé»ž**ï¼š
- âš ï¸ åªé©ç”¨æ–¼é–‹ç™¼ç’°å¢ƒ
- âš ï¸ éœ€è¦åœ¨æœ¬åœ°é‹è¡Œ emulator

---

### **æ–¹æ¡ˆ 3ï¼šé™ç´šåˆ° firebase-functions v3ï¼ˆä½¿ç”¨çœŸæ­£çš„ v1ï¼‰**
**åŽŸç†**ï¼šv3 æ”¯æŒçœŸæ­£çš„ Gen 1 å‡½æ•¸ï¼Œä¸éœ€è¦ Cloud Run IAM

**æ­¥é©Ÿ**ï¼š
1. ä¿®æ”¹ package.jsonï¼š`"firebase-functions": "^3.24.1"`
2. ä¿®æ”¹ `engines.node` ç‚º `"16"` æˆ– `"18"`
3. é‹è¡Œ `npm install` ä¸¦é‡æ–°éƒ¨ç½²

**å„ªé»ž**ï¼š
- âœ… Gen 1 å‡½æ•¸è‡ªå‹•è™•ç† CORS
- âœ… ä¸éœ€è¦ IAM è¨­ç½®

**ç¼ºé»ž**ï¼š
- âš ï¸ ä½¿ç”¨èˆŠç‰ˆæœ¬ï¼ˆä½†ç©©å®šï¼‰
- âš ï¸ éœ€è¦é™ç´š Node.js ç‰ˆæœ¬

---

### **æ–¹æ¡ˆ 4ï¼šè«‹æ±‚çµ„ç¹”ç®¡ç†å“¡èª¿æ•´æ”¿ç­–**
**åŽŸç†**ï¼šå…è¨±ç‰¹å®šåŸŸåçš„å…¬é–‹è¨ªå•

**æ­¥é©Ÿ**ï¼š
1. è¯ç¹« GCP çµ„ç¹”ç®¡ç†å“¡
2. è«‹æ±‚èª¿æ•´ `iam.allowedPolicyMemberDomains` æ”¿ç­–
3. å…è¨± `allUsers` æˆ–ç‰¹å®šåŸŸå

**å„ªé»ž**ï¼š
- âœ… å¾¹åº•è§£æ±ºå•é¡Œ
- âœ… æ‰€æœ‰ç’°å¢ƒéƒ½å¯ç”¨

**ç¼ºé»ž**ï¼š
- âš ï¸ éœ€è¦çµ„ç¹”ç®¡ç†å“¡æ¬Šé™
- âš ï¸ å¯èƒ½éœ€è¦æ™‚é–“æ‰¹å‡†

---

## ðŸŽ¯ æˆ‘çš„å»ºè­°

**ç«‹å³å¯è¡Œ**ï¼š
1. **é–‹ç™¼ç’°å¢ƒ**ï¼šä½¿ç”¨ **æ–¹æ¡ˆ 2ï¼ˆEmulatorï¼‰** 
2. **ç”Ÿç”¢ç’°å¢ƒ**ï¼šä½¿ç”¨ **æ–¹æ¡ˆ 1ï¼ˆHosting Rewriteï¼‰** æˆ– **æ–¹æ¡ˆ 3ï¼ˆé™ç´šåˆ° v3ï¼‰**

**æœ€å¿«è§£æ±ºé–‹ç™¼å•é¡Œçš„æ­¥é©Ÿ**ï¼š
```bash
# 1. å•Ÿå‹• emulator
firebase emulators:start --only functions,auth

# 2. ä¿®æ”¹ firebase.js ä½¿ç”¨ emulator
# ï¼ˆæˆ‘å¯ä»¥å¹«æ‚¨ä¿®æ”¹ä»£ç¢¼ï¼‰

# 3. æ¸¬è©¦ç™»å…¥åŠŸèƒ½
```

---

## â“ æ‚¨å¸Œæœ›æˆ‘ï¼š
1. **å¯¦æ–½æ–¹æ¡ˆ 2**ï¼ˆä½¿ç”¨ Emulator é€²è¡Œé–‹ç™¼ï¼‰ï¼Ÿ
2. **å¯¦æ–½æ–¹æ¡ˆ 3**ï¼ˆé™ç´šåˆ° firebase-functions v3ï¼‰ï¼Ÿ
3. **å¯¦æ–½æ–¹æ¡ˆ 1**ï¼ˆè¨­ç½® Hosting Rewriteï¼‰ï¼Ÿ
4. **å…¶ä»–æƒ³æ³•**ï¼Ÿ

è«‹å‘Šè¨´æˆ‘æ‚¨å¸Œæœ›æŽ¡å–å“ªå€‹æ–¹æ¡ˆï¼Œæˆ‘æœƒç«‹å³åŸ·è¡Œï¼ðŸš€