# functions\index.js
```
const functions = require('firebase-functions');
const admin = require('firebase-admin');
const crypto = require('crypto');

// ç¡®ä¿åªåˆå§‹åŒ–ä¸€æ¬¡
if (!admin.apps.length) {
  admin.initializeApp();
}

const { checkAdminExists, createInitialAdmin, sendOtpToPhone, verifyOtpCode, setProjectInfo, getTotalCapital, getAssignedCapitalSum, createManager } = require('./admin');
exports.checkAdminExists = checkAdminExists;
exports.createInitialAdmin = createInitialAdmin;
exports.sendOtpToPhone = sendOtpToPhone;
exports.verifyOtpCode = verifyOtpCode;
exports.setProjectInfo = setProjectInfo;
exports.getTotalCapital = getTotalCapital;
exports.getAssignedCapitalSum = getAssignedCapitalSum;
exports.createManager = createManager;

// ğŸ”¥ æ·»åŠ  CORS ä¸­é—´ä»¶ - æŒ‰ç…§ Gemini å»ºè­°æ˜ç¢ºé…ç½®
const cors = require('cors')({
  origin: ['http://localhost:5173', 'https://mybazaar-c4881.web.app', 'https://mybazaar-c4881.firebaseapp.com'],
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization'],
  credentials: true
});

// æ ‡å‡†åŒ–æ‰‹æœºå·ç æ ¼å¼
function normalizePhoneNumber(phoneNumber) {
  let cleaned = phoneNumber.replace(/[\s\-\(\)]/g, '');
  
  if (cleaned.startsWith('+60')) {
    cleaned = cleaned.substring(3);
  } else if (cleaned.startsWith('60')) {
    cleaned = cleaned.substring(2);
  }
  
  if (cleaned.startsWith('0')) {
    cleaned = cleaned.substring(1);
  }
  
  return cleaned;
}

// ğŸ”¥ ä¿®å¤ï¼šloginWithPin å‡½æ•¸ - ä½¿ç”¨ onRequest + CORS ä¸­é–“ä»¶ï¼ˆæŒ‰ç…§ Gemini å»ºè­°ï¼‰
exports.loginWithPin = functions.https.onRequest((req, res) => {
  // ä½¿ç”¨ CORS ä¸­é–“ä»¶è™•ç†é æª¢è«‹æ±‚å’Œè·¨åŸŸ
  cors(req, res, async () => {
    try {
      // ä»è¯·æ±‚ä½“è·å–æ•°æ®
      const { phoneNumber, pin, organizationId, eventId } = req.body;
    
    console.log('[loginWithPin] Received:', { 
      phoneNumber, 
      organizationId, 
      eventId, 
      hasPin: !!pin
    });
    
    // éªŒè¯å¿…å¡«å­—æ®µ
    if (!phoneNumber || !pin) {
      return res.status(400).json({ 
        error: { code: 'invalid-argument', message: 'è¯·æä¾›æ‰‹æœºå·ç ä¸å¯†ç ' }
      });
    }
    if (!organizationId || !eventId) {
      return res.status(400).json({ 
        error: { code: 'invalid-argument', message: 'è¯·æä¾›ç»„ç»‡ä¸æ´»åŠ¨ä¿¡æ¯' }
      });
    }
    
    // æ ‡å‡†åŒ–æ‰‹æœºå·ç 
    const normalizedPhone = normalizePhoneNumber(phoneNumber);
    console.log('[loginWithPin] Normalized phone:', normalizedPhone);
    
    // æ­£ç¡®çš„é›†åˆè·¯å¾„
    const collectionPath = `organizations/${organizationId}/events/${eventId}/users`;
    console.log('[loginWithPin] Querying path:', collectionPath);
    
    // æŸ¥è¯¢æ—¶å°è¯•å¤šç§æ‰‹æœºå·æ ¼å¼
    const phoneVariants = [
      normalizedPhone,
      `0${normalizedPhone}`,
      `60${normalizedPhone}`,
      phoneNumber
    ];
    
    console.log('[loginWithPin] Trying phone variants:', phoneVariants);
    
    let userDoc = null;
    let usersSnap = null;
    
    // å°è¯•æ¯ç§æ ¼å¼
    for (const variant of phoneVariants) {
      usersSnap = await admin.firestore()
        .collection(collectionPath)
        .where("basicInfo.phoneNumber", "==", variant)
        .limit(1)
        .get();
      
      if (!usersSnap.empty) {
        userDoc = usersSnap.docs[0];
        console.log('[loginWithPin] Found user with phone variant:', variant);
        break;
      }
    }
    
    if (!userDoc) {
      console.log('[loginWithPin] User not found for any phone variant');
      return res.status(404).json({ 
        error: { code: 'not-found', message: 'æŸ¥æ— æ­¤æ‰‹æœºå·ç ' }
      });
    }
    
    const userData = userDoc.data();
    console.log('[loginWithPin] User data found:', {
      id: userDoc.id,
      phoneNumber: userData.basicInfo?.phoneNumber,
      roles: userData.roles
    });
    
    // éªŒè¯å¯†ç 
    const passwordSalt = userData.basicInfo?.passwordSalt || userData.basicInfo?.pinSalt;
    const storedHash = userData.basicInfo?.passwordHash || userData.basicInfo?.pinHash;
    
    if (!passwordSalt || !storedHash) {
      return res.status(412).json({ 
        error: { code: 'failed-precondition', message: 'ç”¨æˆ·å¯†ç èµ„æ–™ä¸å®Œæ•´' }
      });
    }
    
    const passwordHash = crypto.createHash("sha256").update(pin + passwordSalt).digest("hex");
    
    if (passwordHash !== storedHash) {
      return res.status(403).json({ 
        error: { code: 'permission-denied', message: 'å¯†ç é”™è¯¯' }
      });
    }
    
    // ç”Ÿæˆæˆ–è·å– authUid
    const authUid = `phone_60${normalizedPhone}`;
    console.log('[loginWithPin] Using authUid:', authUid);
    
    let userRecord;
    try {
      userRecord = await admin.auth().getUser(authUid);
      console.log('[loginWithPin] Existing auth user found');
    } catch (error) {
      console.log('[loginWithPin] Creating new auth user');
      userRecord = await admin.auth().createUser({
        uid: authUid,
        displayName: userData.basicInfo?.englishName || userData.basicInfo?.chineseName || phoneNumber
      });
    }
    
    // ç”Ÿæˆè‡ªå®šä¹‰ä»¤ç‰Œ
    const customToken = await admin.auth().createCustomToken(authUid);
    
    // æ›´æ–°ç”¨æˆ·æ–‡æ¡£çš„ authUidï¼ˆå¦‚æœä¸å­˜åœ¨æˆ–ä¸ä¸€è‡´ï¼‰
    const currentAuthUid = userData.authUid || userData.authId || userData.accountStatus?.authUid;
    if (currentAuthUid !== authUid) {
      console.log(`[loginWithPin] Updating authUid from ${currentAuthUid} to ${authUid}`);
      await userDoc.ref.update({ 
        authUid: authUid,
        'accountStatus.authUid': authUid,
        'accountStatus.updatedAt': new Date()
      });
    }
    
    // æ„å»ºè¿”å›çš„ç”¨æˆ·èµ„æ–™
    const userProfile = {
      id: userDoc.id,
      orgId: organizationId,
      eventId: eventId,
      authUid: authUid,
      basicInfo: userData.basicInfo,
      roles: userData.roles || [],
      identityTag: userData.basicInfo?.identityTag || "",
      roleSpecificData: userData.roleSpecificData || {}
    };
    
    console.log('[loginWithPin] Login successful, returning profile');
    
    // è¿”å› JSON éŸ¿æ‡‰
    res.status(200).json({
      customToken,
      userProfile,
      chineseName: userData.basicInfo?.chineseName || "",
      roles: userData.roles || [],
      redirectUrl: getRedirectUrl(userData.roles || [])
    });
    
  } catch (error) {
    console.error('[loginWithPin] Error:', error);
    
    res.status(500).json({ 
      error: { code: 'internal', message: error.message || 'ç™»å…¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•' }
    });
  }
  });
});

// changePassword å‡½æ•°
exports.changePassword = functions.https.onCall(async (data, context) => {
  const { phoneNumber, currentPassword, newPassword } = data;
  
  if (!phoneNumber || !currentPassword || !newPassword) {
    throw new functions.https.HttpsError("invalid-argument", "è¯·æä¾›æ‰‹æœºå·ç ã€å½“å‰å¯†ç å’Œæ–°å¯†ç ");
  }
  
  if (newPassword.length < 8) {
    throw new functions.https.HttpsError("invalid-argument", "æ–°å¯†ç é•¿åº¦è‡³å°‘éœ€è¦8ä¸ªå­—ç¬¦");
  }
  
  const hasLetter = /[a-zA-Z]/.test(newPassword);
  const hasNumber = /[0-9]/.test(newPassword);
  
  if (!hasLetter || !hasNumber) {
    throw new functions.https.HttpsError("invalid-argument", "æ–°å¯†ç å¿…é¡»åŒ…å«è‹±æ–‡å­—æ¯å’Œæ•°å­—");
  }
  
  try {
    const normalizedPhone = normalizePhoneNumber(phoneNumber);
    const phoneVariants = [
      normalizedPhone,
      `0${normalizedPhone}`,
      `60${normalizedPhone}`,
      phoneNumber
    ];
    
    let userDoc = null;
    
    for (const variant of phoneVariants) {
      const usersSnap = await admin.firestore().collection("users")
        .where("basicInfo.phoneNumber", "==", variant)
        .limit(1)
        .get();
      
      if (!usersSnap.empty) {
        userDoc = usersSnap.docs[0];
        break;
      }
    }
    
    if (!userDoc) {
      throw new functions.https.HttpsError("not-found", "æŸ¥æ— æ­¤æ‰‹æœºå·ç ");
    }
    
    const userData = userDoc.data();
    
    const passwordSalt = userData.basicInfo.passwordSalt || userData.basicInfo.pinSalt;
    const currentPasswordHash = crypto.createHash("sha256").update(currentPassword + passwordSalt).digest("hex");
    
    const storedHash = userData.basicInfo.passwordHash || userData.basicInfo.pinHash;
    if (currentPasswordHash !== storedHash) {
      throw new functions.https.HttpsError("permission-denied", "å½“å‰å¯†ç é”™è¯¯");
    }
    
    const newPasswordHash = crypto.createHash("sha256").update(newPassword + passwordSalt).digest("hex");
    
    await userDoc.ref.update({
      "basicInfo.passwordHash": newPasswordHash,
      "basicInfo.pinHash": newPasswordHash,
      "basicInfo.passwordSalt": passwordSalt,
      "basicInfo.pinSalt": passwordSalt
    });
    
    console.log(`[changePassword] Password changed for ${phoneNumber}`);
    return { success: true, message: "å¯†ç ä¿®æ”¹æˆåŠŸ" };
    
  } catch (error) {
    console.error("[changePassword] Error:", error);
    if (error instanceof functions.https.HttpsError) {
      throw error;
    }
    throw new functions.https.HttpsError("internal", `ä¿®æ”¹å¯†ç å¤±è´¥ï¼š${error.message}`);
  }
});

function getRedirectUrl(roles) {
  console.log(`[getRedirectUrl] Checking roles:`, JSON.stringify(roles));
  if (!roles || !Array.isArray(roles)) return "../home/index.html";
  
  if (roles.includes("super_admin") || roles.includes("super admin")) return "../admin/admin-dashboard.html";
  if (roles.includes("manager")) return "../manager/admin-manage-users.html";
  if (roles.includes("merchant")) return "../merchant/merchant-dashboard.html";
  if (roles.includes("seller")) return "../seller/seller-dashboard.html";
  if (roles.includes("customer")) return "../customer/consume.html";
  
  console.log(`[getRedirectUrl] No role matched, returning default`);
  return "../home/index.html";
}

exports.loginAndRedirect = functions.https.onCall(async (data, context) => {
  const userUid = context.auth ? context.auth.uid : null;
  console.log(`[loginAndRedirect] User UID from context: ${userUid}`);
  
  const { phoneNumber } = data;
  
  let userSnap;
  if (userUid) {
    userSnap = await admin.firestore().collection("users").where("authUid", "==", userUid).limit(1).get();
  }
  
  if ((!userSnap || userSnap.empty) && phoneNumber) {
    console.log(`[loginAndRedirect] Fallback to phoneNumber query: ${phoneNumber}`);
    userSnap = await admin.firestore().collection("users")
      .where("basicInfo.phoneNumber", "==", phoneNumber)
      .limit(1)
      .get();
  }
  
  console.log(`[loginAndRedirect] Query result: ${userSnap && !userSnap.empty ? 'found' : 'empty'}`);
  if (!userSnap || userSnap.empty) throw new functions.https.HttpsError("not-found", "æ‰¾ä¸åˆ°ä½¿ç”¨è€…èµ„æ–™ã€‚");
  
  const userData = userSnap.docs[0].data();
  return {
    redirectUrl: getRedirectUrl(userData.roles),
    chineseName: userData.basicInfo && userData.basicInfo.chineseName ? userData.basicInfo.chineseName : "",
    roles: userData.roles,
    identityTag: userData.identityTag || "",
  };
});

exports.getManagers = functions.https.onCall(async (data, context) => {
  try {
    const managersSnap = await admin.firestore().collection("managers").get();
    const managers = [];

    managersSnap.forEach(doc => {
      managers.push({
        id: doc.id,
        ...doc.data()
      });
    });

    return { managers };
  } catch (error) {
    console.error("Error fetching managers:", error);
    throw new functions.https.HttpsError("internal", "Unable to fetch managers.");
  }
});

// å¯¼å‡º Firestore èµ„æ–™çš„ Cloud Function
exports.exportFirestoreData = functions.https.onRequest(async (req, res) => {
  // ğŸ”¥ æ·»åŠ  CORS æ”¯æŒ
  res.set('Access-Control-Allow-Origin', '*');
  res.set('Access-Control-Allow-Methods', 'GET, POST');
  res.set('Access-Control-Allow-Headers', 'Content-Type');
  
  if (req.method === 'OPTIONS') {
    res.status(204).send('');
    return;
  }
  
  try {
    console.log('ğŸš€ å¼€å§‹å¯¼å‡º Firestore èµ„æ–™...');
    
    const exportData = {};
    const collections = await admin.firestore().listCollections();
    
    for (const collection of collections) {
      console.log(`ğŸ“ å¯¼å‡ºé›†åˆ: ${collection.id}`);
      const snapshot = await collection.get();
      exportData[collection.id] = {};
      
      for (const doc of snapshot.docs) {
        exportData[collection.id][doc.id] = doc.data();
        
        const subcollections = await doc.ref.listCollections();
        if (subcollections.length > 0) {
          exportData[collection.id][doc.id]._subcollections = {};
          
          for (const subcol of subcollections) {
            const subSnapshot = await subcol.get();
            exportData[collection.id][doc.id]._subcollections[subcol.id] = {};
            
            subSnapshot.docs.forEach(subDoc => {
              exportData[collection.id][doc.id]._subcollections[subcol.id][subDoc.id] = subDoc.data();
            });
          }
        }
      }
      
      console.log(`  âœ… ${collection.id}: ${snapshot.size} ä¸ªæ–‡æ¡£`);
    }
    
    console.log('âœ… å¯¼å‡ºå®Œæˆï¼');
    
    res.status(200).json({
      success: true,
      exportDate: new Date().toISOString(),
      data: exportData
    });
    
  } catch (error) {
    console.error('âŒ å¯¼å‡ºå¤±è´¥:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});
```

# src\services\authService.js
```
// src/services/authService.js
import { auth, db, functions } from '../config/firebase';
import { signInWithCustomToken, signOut } from 'firebase/auth';
import { httpsCallable } from 'firebase/functions';
import { query, where, collection, getDocs } from 'firebase/firestore';

/**
 * ğŸ”¥ ä¿®å¾©ï¼šæ¨™æº–åŒ–æ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼
 */
function normalizePhone(phoneNumber) {
  if (!phoneNumber) return null;
  
  // ç§»é™¤æ‰€æœ‰ç©ºæ ¼å’Œç‰¹æ®Šå­—ç¬¦
  let cleaned = phoneNumber.trim().replace(/[\s\-\(\)]/g, '');
  
  // å¦‚æœä»¥ +60 æˆ– 60 é–‹é ­ï¼Œç§»é™¤å®ƒ
  if (cleaned.startsWith('+60')) {
    cleaned = cleaned.substring(3);
  } else if (cleaned.startsWith('60')) {
    cleaned = cleaned.substring(2);
  }
  
  // å¦‚æœä»¥ 0 é–‹é ­ï¼Œç§»é™¤å®ƒ
  if (cleaned.startsWith('0')) {
    cleaned = cleaned.substring(1);
  }
  
  // é©—è­‰æ ¼å¼ï¼šæ‡‰è©²æ˜¯ 1 é–‹é ­ï¼Œå¾Œæ¥ 8-9 ä½æ•¸å­—ï¼ˆé¦¬ä¾†è¥¿äºæ‰‹æ©Ÿè™Ÿï¼‰
  if (!/^1\d{8,9}$/.test(cleaned)) {
    return null;
  }
  
  // è¿”å›æ¨™æº–æ ¼å¼ï¼š0 + æ•¸å­—ï¼ˆä¾‹å¦‚ï¼š0123456789ï¼‰
  return '0' + cleaned;
}

/**
 * é©—è­‰å¯†ç¢¼å¼·åº¦
 */
function validatePassword(password) {
  if (!password || password.length < 8) return false;
  const hasLetter = /[a-zA-Z]/.test(password);
  const hasNumber = /\d/.test(password);
  return hasLetter && hasNumber;
}

/**
 * ğŸ”¥ ä¿®å¾©ï¼šä½¿ç”¨ PIN ç¢¼ç™»å…¥
 */
async function loginWithPin(phoneNumber, password, organizationId, eventId) {
  try {
    console.log('[authService] Login attempt:', { 
      phoneNumber, 
      organizationId, 
      eventId 
    });
    
    // é©—è­‰åƒæ•¸
    if (!phoneNumber || !password || !organizationId || !eventId) {
      throw new Error('è«‹æä¾›å®Œæ•´çš„ç™»å…¥ä¿¡æ¯');
    }
    
    // æ¨™æº–åŒ–æ‰‹æ©Ÿè™Ÿç¢¼
    const normalized = normalizePhone(phoneNumber);
    if (!normalized) {
      throw new Error('æ‰‹æ©Ÿè™Ÿæ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹è¼¸å…¥ 01 é–‹é ­çš„ 10-11 ä½æ•¸å­—');
    }
    
    console.log('[authService] Normalized phone:', normalized);
    
    // é©—è­‰å¯†ç¢¼
    if (!validatePassword(password)) {
      throw new Error('å¯†ç¢¼è‡³å°‘éœ€è¦ 8 å€‹å­—ç¬¦ï¼Œä¸”å¿…é ˆåŒ…å«è‹±æ–‡å­—æ¯å’Œæ•¸å­—');
    }
    
    // ğŸ”¥ èª¿ç”¨ Cloud Function - ä½¿ç”¨ fetch ç›´æ¥è«‹æ±‚ï¼ˆæŒ‰ç…§ Gemini å»ºè­°ï¼‰
    console.log('[authService] Calling Cloud Function...');
    
    const functionUrl = 'https://us-central1-mybazaar-c4881.cloudfunctions.net/loginWithPin';
    
    const response = await fetch(functionUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        phoneNumber: normalized,
        pin: password,
        organizationId,
        eventId
      })
    });
    
    if (!response.ok) {
      const errorData = await response.json().catch(() => ({ error: { message: 'Unknown error' } }));
      throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
    }
    
    const result = await response.json();
    
    console.log('[authService] Cloud Function response received');
    console.log('[authService] Response data:', {
      hasCustomToken: !!result?.customToken,
      hasUserProfile: !!result?.userProfile
    });
    
    if (!result?.customToken) {
      console.error('[authService] No custom token in response');
      throw new Error(result?.message || 'ç™»å…¥å¤±æ•—ï¼šæœªæ”¶åˆ°èªè­‰ä»¤ç‰Œ');
    }
    
    // ğŸ”¥ ä½¿ç”¨è‡ªå®šç¾©ä»¤ç‰Œç™»å…¥ Firebase Auth
    console.log('[authService] Signing in with custom token...');
    try {
      await signInWithCustomToken(auth, result.customToken);
      console.log('[authService] Firebase Auth sign-in successful');
    } catch (authError) {
      console.error('[authService] Firebase Auth error:', authError);
      throw new Error('èªè­‰å¤±æ•—ï¼Œè«‹é‡è©¦');
    }
    
    return {
      success: true,
      user: result,
      userProfile: result.userProfile,
      message: 'ç™»å…¥æˆåŠŸ'
    };
    
  } catch (error) {
    console.error('[authService] Login error:', {
      name: error.name,
      code: error.code,
      message: error.message,
      stack: error.stack
    });
    
    // ğŸ”¥ çµ±ä¸€éŒ¯èª¤è™•ç†
    let errorMessage = 'ç™»å…¥å¤±æ•—';
    
    if (error.code === 'not-found') {
      errorMessage = 'æŸ¥ç„¡æ­¤æ‰‹æ©Ÿè™Ÿç¢¼ï¼Œè«‹ç¢ºèªå¾Œé‡è©¦';
    } else if (error.code === 'permission-denied') {
      errorMessage = 'å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥';
    } else if (error.code === 'invalid-argument') {
      errorMessage = error.message || 'è¼¸å…¥è³‡æ–™æ ¼å¼ä¸æ­£ç¢º';
    } else if (error.code === 'internal') {
      errorMessage = 'æœå‹™å™¨å…§éƒ¨éŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦';
    } else if (error.code === 'unavailable' || error.code === 'deadline-exceeded') {
      errorMessage = 'ç¶²çµ¡é€£æ¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡å¾Œé‡è©¦';
    } else if (error.message) {
      errorMessage = error.message;
    }
    
    throw new Error(errorMessage);
  }
}

/**
 * ç™»å‡º
 */
async function logout() {
  try {
    await signOut(auth);
    console.log('[authService] Logout successful');
  } catch (error) {
    console.error('[authService] Logout error:', error);
    throw error;
  }
}

/**
 * ğŸ”¥ ä¿®å¾©ï¼šæ ¹æ“š authUid ç²å–ç”¨æˆ¶è³‡æ–™
 */
async function getUserProfile(authUid, orgId, eventId) {
  if (!authUid || !orgId || !eventId) {
    throw new Error('getUserProfile requires authUid, orgId, and eventId');
  }

  try {
    const userCollectionPath = `organizations/${orgId}/events/${eventId}/users`;
    console.log('[authService] Querying user from:', userCollectionPath);
    
    const q = query(
      collection(db, userCollectionPath),
      where('authUid', '==', authUid)
    );
    
    const querySnapshot = await getDocs(q);
    
    if (querySnapshot.empty) {
      // ğŸ”¥ å˜—è©¦æŸ¥è©¢å…¶ä»–å¯èƒ½çš„ authUid å­—æ®µ
      const alternativeFields = ['accountStatus.authUid', 'authId', 'authMid'];
      
      for (const field of alternativeFields) {
        const altQ = query(
          collection(db, userCollectionPath),
          where(field, '==', authUid)
        );
        
        const altSnapshot = await getDocs(altQ);
        if (!altSnapshot.empty) {
          console.log(`[authService] Found user with ${field}`);
          const userDoc = altSnapshot.docs[0];
          return {
            id: userDoc.id,
            orgId,
            eventId,
            ...userDoc.data()
          };
        }
      }
      
      console.warn('[authService] No user profile found for authUid:', authUid);
      return null;
    }
    
    const userDoc = querySnapshot.docs[0];
    return {
      id: userDoc.id,
      orgId,
      eventId,
      ...userDoc.data()
    };
  } catch (error) {
    console.error('[authService] Error getting user profile:', error);
    throw error;
  }
}

/**
 * ä¿®æ”¹å¯†ç¢¼
 */
async function changePassword(phoneNumber, currentPassword, newPassword) {
  try {
    const normalized = normalizePhone(phoneNumber);
    if (!normalized) {
      throw new Error('æ‰‹æ©Ÿè™Ÿæ ¼å¼ä¸æ­£ç¢º');
    }

    if (!validatePassword(newPassword)) {
      throw new Error('æ–°å¯†ç¢¼è‡³å°‘éœ€è¦ 8 å€‹å­—ç¬¦ï¼Œä¸”å¿…é ˆåŒ…å«è‹±æ–‡å­—æ¯å’Œæ•¸å­—');
    }

    const changePasswordFn = httpsCallable(functions, 'changePassword');
    const result = await changePasswordFn({
      phoneNumber: normalized,
      currentPassword,
      newPassword
    });

    return result.data;
  } catch (error) {
    console.error('[authService] Change password error:', error);
    throw new Error(error.message || 'ä¿®æ”¹å¯†ç¢¼å¤±æ•—');
  }
}

/**
 * ç™¼é€ OTP
 */
async function sendOtp(phoneNumber, pinCode) {
  try {
    const normalized = normalizePhone(phoneNumber);
    if (!normalized) {
      throw new Error('æ‰‹æ©Ÿè™Ÿæ ¼å¼ä¸æ­£ç¢º');
    }

    const sendOtpFn = httpsCallable(functions, 'sendOtpToPhone');
    const result = await sendOtpFn({
      phoneNumber: normalized,
      pinCode
    });

    return result.data;
  } catch (error) {
    console.error('[authService] Send OTP error:', error);
    throw new Error(error.message || 'ç™¼é€ OTP å¤±æ•—');
  }
}

// å°å‡ºæ‰€æœ‰å‡½æ•¸
export const authService = {
  loginWithPin,
  logout,
  getUserProfile,
  changePassword,
  sendOtp,
  normalizePhone,
  validatePassword
};
```

# src\contexts\AuthContext.jsx
```
// src/contexts/AuthContext.jsx
import { createContext, useContext, useState, useEffect } from 'react';
import { auth } from '../config/firebase';
import { onAuthStateChanged } from 'firebase/auth';
import { authService } from '../services/authService';
import { useEvent } from './EventContext';

const AuthContext = createContext();

export const useAuth = () => {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error('useAuth must be used within AuthProvider');
  }
  return context;
};

export const AuthProvider = ({ children }) => {
  const [currentUser, setCurrentUser] = useState(null);
  const [userProfile, setUserProfile] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  
  const { organizationId, eventId } = useEvent();

  // ç›‘å¬ Firebase Auth çŠ¶æ€å˜åŒ–
  useEffect(() => {
    if (!organizationId || !eventId) {
      console.warn('[AuthContext] No organizationId or eventId');
      setLoading(false);
      return;
    }

    const unsubscribe = onAuthStateChanged(auth, async (user) => {
      console.log('[AuthContext] Auth state changed:', user ? user.uid : 'no user');
      
      if (user && !user.isAnonymous) {
        setCurrentUser(user);
        
        // ğŸ”¥ æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ç”¨æˆ·èµ„æ–™ï¼ˆä»ç™»å½•æ—¶è·å¾—ï¼‰
        if (!userProfile) {
          // å¦‚æœæ²¡æœ‰ï¼Œå°è¯•ä» Firestore åŠ è½½ï¼ˆéœ€è¦æ­£ç¡®çš„æƒé™ï¼‰
          try {
            const profile = await authService.getUserProfile(
              user.uid, 
              organizationId, 
              eventId
            );
            setUserProfile(profile);
            console.log('[AuthContext] User profile loaded from Firestore:', profile);
          } catch (err) {
            console.error('[AuthContext] Failed to load user profile:', err);
            // ä¸è®¾ç½®ä¸º nullï¼Œä¿ç•™å·²æœ‰çš„ userProfile
          }
        }
      } else {
        setCurrentUser(null);
        setUserProfile(null);
      }
      
      setLoading(false);
    });

    return () => unsubscribe();
  }, [organizationId, eventId, userProfile]);

  // ç™»å…¥å‡½æ•°
  const login = async (phoneNumber, password) => {
    try {
      setError(null);
      setLoading(true);
      
      console.log('[AuthContext] Login called');
      
      if (!organizationId || !eventId) {
        throw new Error('æ— æ³•è·å–ç»„ç»‡æˆ–æ´»åŠ¨ä¿¡æ¯ï¼Œè¯·é‡æ–°åŠ è½½é¡µé¢');
      }
      
      const result = await authService.loginWithPin(phoneNumber, password, organizationId, eventId);
      
      // ğŸ”¥ å¦‚æœç™»å½•è¿”å›äº†ç”¨æˆ·èµ„æ–™ï¼Œç›´æ¥è®¾ç½®
      if (result.userProfile) {
        setUserProfile(result.userProfile);
        console.log('[AuthContext] User profile set from login result:', result.userProfile);
      }
      
      return result;
    } catch (err) {
      console.error('[AuthContext] Login error:', err);
      setError(err.message);
      throw err;
    } finally {
      setLoading(false);
    }
  };

  const logout = async () => {
    try {
      await authService.logout();
      setCurrentUser(null);
      setUserProfile(null);
    } catch (err) {
      console.error('[AuthContext] Logout error:', err);
      throw err;
    }
  };

  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ç‰¹å®šè§’è‰²
  const hasRole = (role) => {
    if (!userProfile || !userProfile.roles) return false;
    return userProfile.roles.includes(role);
  };

  // è·å–ç”¨æˆ·ä¸»è¦è§’è‰²ï¼ˆä¼˜å…ˆçº§æœ€é«˜çš„è§’è‰²ï¼‰
  const getPrimaryRole = () => {
    if (!userProfile || !userProfile.roles) return null;
    
    const rolePriority = [
      'platform_admin',
      'org_admin', 
      'event_manager',
      'manager',
      'merchant',
      'seller',
      'customer'
    ];
    
    for (const role of rolePriority) {
      if (userProfile.roles.includes(role)) {
        return role;
      }
    }
    
    return null;
  };

  const value = {
    currentUser,
    userProfile,
    loading,
    error,
    login,
    logout,
    hasRole,
    getPrimaryRole,
    isAuthenticated: !!currentUser && !currentUser.isAnonymous
  };

  return (
    <AuthContext.Provider value={value}>
      {children}
    </AuthContext.Provider>
  );
};
```
# src\views\desktop\auth\Login.jsx
```
// src/views/desktop/auth/Login.jsx
import { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../../../contexts/AuthContext';
import { useEvent } from '../../../contexts/EventContext';

const DesktopLogin = () => {
  const navigate = useNavigate();
  const { login } = useAuth();
  const { orgCode, eventCode, organization, event } = useEvent();

  const [formData, setFormData] = useState({
    phoneNumber: '',
    password: ''
  });
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: value
    }));
    if (error) setError('');
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    if (!formData.phoneNumber || !formData.password) {
      setError('è¯·å¡«å†™å®Œæ•´çš„æ‰‹æœºå·å’Œå¯†ç ');
      return;
    }

    if (!/^01\d{8,9}$/.test(formData.phoneNumber)) {
      setError('æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·è¾“å…¥01å¼€å¤´çš„10-11ä½æ•°å­—');
      return;
    }

    if (formData.password.length < 8) {
      setError('å¯†ç è‡³å°‘éœ€è¦8ä¸ªå­—ç¬¦');
      return;
    }

    try {
      setLoading(true);
      setError('');

      await login(formData.phoneNumber, formData.password);

      // ç™»å½•æˆåŠŸï¼Œè·³è½¬åˆ°æ¡Œé¢ç‰ˆé¦–é¡µ
      navigate(`/${orgCode}-${eventCode}/desktop`);
    } catch (err) {
      console.error('[DesktopLogin] Login failed:', err);
      setError(err.message || 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div style={styles.container}>
      <div style={styles.leftPanel}>
        <div style={styles.brandSection}>
          <h1 style={styles.brandTitle}>
            {organization?.orgName?.['zh-CN'] || 'ä¹‰å–ä¼šç®¡ç†ç³»ç»Ÿ'}
          </h1>
          <p style={styles.brandSubtitle}>
            {event?.eventName?.['zh-CN'] || 'æ´»åŠ¨ç®¡ç†å¹³å°'}
          </p>
          <div style={styles.features}>
            <div style={styles.feature}>âœ“ å®‰å…¨å¯é </div>
            <div style={styles.feature}>âœ“ ç®€å•æ˜“ç”¨</div>
            <div style={styles.feature}>âœ“ å®æ—¶æ›´æ–°</div>
          </div>
        </div>
      </div>

      <div style={styles.rightPanel}>
        <div style={styles.loginCard}>
          <div style={styles.header}>
            <h2 style={styles.title}>æ¬¢è¿å›æ¥</h2>
            <p style={styles.subtitle}>è¯·ç™»å½•æ‚¨çš„è´¦å·</p>
          </div>

          <form onSubmit={handleSubmit} style={styles.form}>
            <div style={styles.formGroup}>
              <label style={styles.label}>æ‰‹æœºå·</label>
              <input
                type="tel"
                name="phoneNumber"
                value={formData.phoneNumber}
                onChange={handleChange}
                placeholder="01xxxxxxxx"
                style={styles.input}
                disabled={loading}
                inputMode="numeric"
                pattern="^01\d{8,9}$"
                maxLength="11"
              />
              <small style={styles.hint}>é©¬æ¥è¥¿äºšæ‰‹æœºå·ï¼Œ01å¼€å¤´</small>
            </div>

            <div style={styles.formGroup}>
              <label style={styles.label}>å¯†ç </label>
              <input
                type="password"
                name="password"
                value={formData.password}
                onChange={handleChange}
                placeholder="è‡³å°‘8ä½ï¼ŒåŒ…å«è‹±æ–‡å’Œæ•°å­—"
                style={styles.input}
                disabled={loading}
                minLength="8"
              />
            </div>

            {error && (
              <div style={styles.errorMessage}>
                âš ï¸ {error}
              </div>
            )}

            <button
              type="submit"
              style={{
                ...styles.submitButton,
                ...(loading ? styles.submitButtonDisabled : {})
              }}
              disabled={loading}
            >
              {loading ? 'ç™»å½•ä¸­...' : 'ç™»å½•'}
            </button>
          </form>

          <div style={styles.footer}>
            <p style={styles.footerText}>
              è¿˜æ²¡æœ‰è´¦å·ï¼Ÿè¯·è”ç³»ç®¡ç†å‘˜æ³¨å†Œ
            </p>
          </div>
        </div>
      </div>
    </div>
  );
};

const styles = {
  container: {
    display: 'flex',
    minHeight: '100vh'
  },
  leftPanel: {
    flex: 1,
    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    padding: '3rem',
    color: 'white'
  },
  brandSection: {
    maxWidth: '500px'
  },
  brandTitle: {
    fontSize: '2.5rem',
    fontWeight: 'bold',
    marginBottom: '1rem',
    lineHeight: '1.2'
  },
  brandSubtitle: {
    fontSize: '1.25rem',
    opacity: 0.9,
    marginBottom: '3rem'
  },
  features: {
    display: 'flex',
    flexDirection: 'column',
    gap: '1rem'
  },
  feature: {
    fontSize: '1.125rem',
    opacity: 0.95
  },
  rightPanel: {
    flex: 1,
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    padding: '3rem',
    background: '#f9fafb'
  },
  loginCard: {
    background: 'white',
    borderRadius: '16px',
    padding: '3rem',
    width: '100%',
    maxWidth: '450px',
    boxShadow: '0 10px 40px rgba(0, 0, 0, 0.1)'
  },
  header: {
    marginBottom: '2rem'
  },
  title: {
    fontSize: '2rem',
    fontWeight: 'bold',
    color: '#1f2937',
    margin: '0 0 0.5rem 0'
  },
  subtitle: {
    fontSize: '1rem',
    color: '#6b7280',
    margin: 0
  },
  form: {
    display: 'flex',
    flexDirection: 'column',
    gap: '1.5rem'
  },
  formGroup: {
    display: 'flex',
    flexDirection: 'column',
    gap: '0.5rem'
  },
  label: {
    fontSize: '0.875rem',
    fontWeight: '600',
    color: '#374151'
  },
  input: {
    padding: '0.875rem',
    fontSize: '1rem',
    border: '1px solid #d1d5db',
    borderRadius: '8px',
    outline: 'none',
    transition: 'border-color 0.2s',
    width: '100%',
    boxSizing: 'border-box'
  },
  hint: {
    fontSize: '0.75rem',
    color: '#6b7280'
  },
  errorMessage: {
    padding: '0.875rem',
    background: '#fee2e2',
    color: '#991b1b',
    borderRadius: '8px',
    fontSize: '0.875rem',
    border: '1px solid #fecaca'
  },
  submitButton: {
    padding: '1rem',
    fontSize: '1rem',
    fontWeight: '600',
    color: 'white',
    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
    border: 'none',
    borderRadius: '8px',
    cursor: 'pointer',
    transition: 'transform 0.2s, opacity 0.2s',
    marginTop: '0.5rem'
  },
  submitButtonDisabled: {
    opacity: 0.6,
    cursor: 'not-allowed'
  },
  footer: {
    marginTop: '2rem',
    paddingTop: '2rem',
    borderTop: '1px solid #e5e7eb',
    textAlign: 'center'
  },
  footerText: {
    fontSize: '0.875rem',
    color: '#6b7280',
    margin: 0
  }
};

export default DesktopLogin;
```
