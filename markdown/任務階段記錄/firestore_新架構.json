{
  "firestore_architecture": "子集合架构（迁移后）",
  "version": "2.0",
  "migration_date": "2025-10-22",
  "project": "mybazaar-c4881",
  "description": "这是 Firestore 迁移后的完整数据架构，使用子集合代替嵌套对象",

  "collection_organizations": {
    "_type": "Collection",
    "_path": "organizations",
    "_description": "顶级集合：所有组织",
    
    "documents": {
      "VyJ7kgHC70hn7QjmdUPK": {
        "_type": "Document",
        "_path": "organizations/VyJ7kgHC70hn7QjmdUPK",
        "_description": "组织：芙蓉中学",
        "_note": "此组织没有活动，events 子集合为空",
        
        "orgCode": "chhsban",
        "orgName": {
          "en": "Chung Hua High School Seremban",
          "zh-CN": "芙蓉中学芙蓉"
        },
        "contactInfo": {
          "address": "10, jalan tun ismail, seremban",
          "email": "admin@chhsban.edu.my",
          "phone": "0181234567"
        },
        "settings": {
          "currency": "MYR",
          "defaultLanguage": "zh-CN",
          "supportedLanguages": ["zh-CN", "en"],
          "timezone": "Asia/Kuala_Lumpur"
        },
        "statistics": {
          "activeEvents": 0,
          "totalEvents": 0,
          "totalTransactions": 0,
          "totalUsers": 0
        },
        "status": "active",
        "admins": [],
        "createdAt": "2025-10-11T10:39:46+08:00",
        "createdBy": "platform_admin",
        "updatedAt": "2025-10-11T10:39:46+08:00",
        
        "_subcollections": {
          "events": {
            "_type": "Subcollection",
            "_path": "organizations/VyJ7kgHC70hn7QjmdUPK/events",
            "_description": "此组织的活动子集合（当前为空）",
            "documents": {}
          }
        }
      },
      
      "fYqHtUWjh58NVJJsCMan": {
        "_type": "Document",
        "_path": "organizations/fYqHtUWjh58NVJJsCMan",
        "_description": "组织：芙蓉新华小学",
        "_note": "此组织有 1 个活动，包含 5 个用户",
        
        "orgCode": "xhessbn",
        "orgName": {
          "en": "Xin Hua Element School",
          "zh-CN": "芙蓉新华小学"
        },
        "contactInfo": {
          "address": "test,jalan test",
          "email": "test@test.edu.my",
          "phone": "0123456789"
        },
        "settings": {
          "currency": "MYR",
          "defaultLanguage": "zh-CN",
          "supportedLanguages": ["zh-CN", "en"],
          "timezone": "Asia/Kuala_Lumpur"
        },
        "statistics": {
          "activeEvents": 1,
          "totalEvents": 1,
          "totalTransactions": 0,
          "totalUsers": 5
        },
        "status": "active",
        "admins": [
          {
            "userId": "phone_60123456789",
            "authUid": "phone_60123456789",
            "phoneNumber": "0123456789",
            "englishName": "John Doe",
            "chineseName": "张三",
            "role": "event_manager",
            "eventId": "zcaWnsF3zTNeqZ738x2V",
            "addedAt": "2025-10-11T10:39:46+08:00",
            "addedBy": "platform_admin"
          }
        ],
        "createdAt": "2025-10-11T18:45:51+08:00",
        "createdBy": "platform_admin",
        "updatedAt": "2025-10-22T10:00:00+08:00",
        
        "_subcollections": {
          "events": {
            "_type": "Subcollection",
            "_path": "organizations/fYqHtUWjh58NVJJsCMan/events",
            "_description": "此组织的活动子集合",
            
            "documents": {
              "zcaWnsF3zTNeqZ738x2V": {
                "_type": "Document",
                "_path": "organizations/fYqHtUWjh58NVJJsCMan/events/zcaWnsF3zTNeqZ738x2V",
                "_description": "活动：2025年新华义卖会",
                "_note": "此活动有 5 个用户在 users 子集合中",
                
                "eventCode": "2025",
                "eventName": {
                  "en": "2025 Xin Hua Charity Fair",
                  "zh-CN": "2025芙蓉新华小学义卖会"
                },
                "eventInfo": {
                  "description": {
                    "en": "2025 Xin Hua Charity Fair",
                    "zh-CN": "2025年新华公益市集"
                  },
                  "fairDate": "2025-12-01",
                  "fairTime": "09:00-17:00",
                  "location": "Xin Hua School Hall",
                  "purpose": "爱心筹集与资源置换",
                  "consumptionPeriod": {
                    "startDate": "2025-11-30",
                    "endDate": "2025-12-01"
                  },
                  "systemPeriod": {
                    "openDate": "2025-09-01",
                    "closeDate": "2025-12-05"
                  },
                  "voucherSalesPeriod": {
                    "startDate": "2025-09-01",
                    "endDate": "2025-11-11"
                  }
                },
                "settings": {
                  "allowCustomerRegistration": true,
                  "multiLanguage": true,
                  "pointToRinggitRatio": 1,
                  "requireOTP": true,
                  "totalCapital": 2000000
                },
                "statistics": {
                  "totalUsers": 5,
                  "totalManagers": 1,
                  "totalSellers": 1,
                  "totalMerchants": 1,
                  "totalCustomers": 3,
                  "assignedCapital": 100000,
                  "availableCapital": 1900000,
                  "totalPointsIssued": 2000,
                  "totalPointsConsumed": 0,
                  "totalTransactions": 0
                },
                "status": "planning",
                "eventManager": null,
                "createdAt": "2025-10-11T19:01:32+08:00",
                "createdBy": "platform_admin",
                "updatedAt": "2025-10-22T10:00:00+08:00",
                
                "_subcollections": {
                  "users": {
                    "_type": "Subcollection",
                    "_path": "organizations/fYqHtUWjh58NVJJsCMan/events/zcaWnsF3zTNeqZ738x2V/users",
                    "_description": "此活动的用户子集合",
                    
                    "documents": {
                      "phone_60123456786": {
                        "_type": "Document",
                        "_path": "organizations/fYqHtUWjh58NVJJsCMan/events/zcaWnsF3zTNeqZ738x2V/users/phone_60123456786",
                        "_description": "用户：Diana Manager（Manager角色）",
                        
                        "userId": "phone_60123456786",
                        "authUid": "phone_60123456786",
                        "identityTag": "staff",
                        "roles": ["manager"],
                        "basicInfo": {
                          "phoneNumber": "0123456786",
                          "englishName": "Diana Manager",
                          "chineseName": "管理员小黛",
                          "email": "diana@test.com",
                          "isPhoneVerified": true,
                          "passwordHash": "f562db0e42e87287913b3d68699d0c76a1aeb63b4a0d1ba0f4766ced650ecfb4",
                          "passwordSalt": "3af974dac3612a51426fe10e47316e46"
                        },
                        "roleSpecificData": {
                          "manager": {
                            "managerId": "M1760233825085",
                            "assignedCapital": 100000,
                            "availableCapital": 100000,
                            "allocatedToSellers": 0
                          }
                        },
                        "accountStatus": {
                          "status": "active",
                          "createdAt": "2025-10-12T08:50:24+08:00",
                          "updatedAt": "2025-10-12T08:50:24+08:00"
                        }
                      },
                      
                      "phone_60123456787": {
                        "_type": "Document",
                        "_path": "organizations/fYqHtUWjh58NVJJsCMan/events/zcaWnsF3zTNeqZ738x2V/users/phone_60123456787",
                        "_description": "用户：Bob Seller（Seller角色）",
                        
                        "userId": "phone_60123456787",
                        "authUid": "phone_601234567898",
                        "identityTag": "staff",
                        "roles": ["seller"],
                        "basicInfo": {
                          "phoneNumber": "0123456787",
                          "englishName": "Bob Seller",
                          "chineseName": "销售员小谢",
                          "email": "bob@test.com",
                          "isPhoneVerified": true,
                          "passwordHash": "84114bdb0b18123fd2b47d8cfde31e698c94c59dfebb5a795406eb2ad9db0c9e",
                          "passwordSalt": "a82ee9648c8595e8571928edc133990a"
                        },
                        "roleSpecificData": {
                          "seller": {
                            "assignedCapital": 0,
                            "availableCapital": 0,
                            "totalPointsSold": 0,
                            "currentSalesAmount": 0
                          }
                        },
                        "accountStatus": {
                          "status": "active",
                          "createdAt": "2025-10-12T08:50:24+08:00",
                          "updatedAt": "2025-10-12T08:50:24+08:00"
                        }
                      },
                      
                      "phone_60123456788": {
                        "_type": "Document",
                        "_path": "organizations/fYqHtUWjh58NVJJsCMan/events/zcaWnsF3zTNeqZ738x2V/users/phone_60123456788",
                        "_description": "用户：Charlie Merchant（Customer + Merchant 双角色）",
                        
                        "userId": "phone_60123456788",
                        "authUid": "phone_6012345678",
                        "identityTag": "staff",
                        "roles": ["customer", "merchant"],
                        "basicInfo": {
                          "phoneNumber": "0123456788",
                          "englishName": "Charlie Merchant",
                          "chineseName": "商家小查",
                          "email": "charlie@merchant.com",
                          "isPhoneVerified": true,
                          "passwordHash": "419b045587e49f845861c521139a33fc6da26427294bb3007db3ad5b57adc144",
                          "passwordSalt": "e5c76af8d222cd800a30548c2f168eff"
                        },
                        "roleSpecificData": {
                          "customer": {
                            "currentBalance": 1000,
                            "totalPointsPurchased": 1000,
                            "totalPointsConsumed": 0
                          },
                          "merchant": {
                            "totalReceivedPoints": 0,
                            "monthlyReceivedPoints": 0
                          }
                        },
                        "accountStatus": {
                          "status": "active",
                          "createdAt": "2025-10-12T09:50:25+08:00",
                          "updatedAt": "2025-10-12T09:50:25+08:00"
                        }
                      },
                      
                      "phone_60123456789": {
                        "_type": "Document",
                        "_path": "organizations/fYqHtUWjh58NVJJsCMan/events/zcaWnsF3zTNeqZ738x2V/users/phone_60123456789",
                        "_description": "用户：Alice Customer（Customer + Event Manager 双角色）",
                        
                        "userId": "phone_60123456789",
                        "authUid": "phone_60123456789",
                        "identityTag": "staff",
                        "roles": ["customer", "event_manager"],
                        "basicInfo": {
                          "phoneNumber": "0123456789",
                          "englishName": "Alice Customer",
                          "chineseName": "顾客小爱",
                          "email": "alice@customer.com",
                          "isPhoneVerified": true,
                          "passwordHash": "fbfaed5fc526d0b369dda3a6f8999571bc897cf1b7b1c965f9e90fdd02ca86a7",
                          "passwordSalt": "81452b5a52202fe62e7bd57d3633aedc"
                        },
                        "roleSpecificData": {
                          "customer": {
                            "currentBalance": 1000,
                            "totalPointsPurchased": 1000,
                            "totalPointsConsumed": 0
                          },
                          "event_manager": {
                            "organizationId": "fYqHtUWjh58NVJJsCMan",
                            "eventId": "zcaWnsF3zTNeqZ738x2V",
                            "assignedAt": "2025-10-12T09:50:25+08:00",
                            "assignedBy": "platform_admin"
                          }
                        },
                        "accountStatus": {
                          "status": "active",
                          "createdAt": "2025-10-12T09:50:25+08:00",
                          "updatedAt": "2025-10-12T09:50:25+08:00"
                        }
                      },
                      
                      "usr_4d711157-ff50-4fe7-bbcf-0a6b26a7b815": {
                        "_type": "Document",
                        "_path": "organizations/fYqHtUWjh58NVJJsCMan/events/zcaWnsF3zTNeqZ738x2V/users/usr_4d711157-ff50-4fe7-bbcf-0a6b26a7b815",
                        "_description": "用户：Alice Wong（Event Manager 角色）",
                        
                        "userId": "usr_4d711157-ff50-4fe7-bbcf-0a6b26a7b815",
                        "authUid": "usr_4d711157-ff50-4fe7-bbcf-0a6b26a7b815",
                        "identityTag": "staff",
                        "roles": ["event_manager"],
                        "basicInfo": {
                          "phoneNumber": "0121211212",
                          "englishName": "Alice Wong",
                          "chineseName": "小王",
                          "email": "astcws@hotmail.com",
                          "isPhoneVerified": false,
                          "passwordHash": "cbcce7fc1052ac4832ba9a4746d83690fe7a3fc94c6e174ecc3790b81a68c593",
                          "passwordSalt": "814bb2db9c760128697fea6856bf7c25",
                          "pinHash": "cbcce7fc1052ac4832ba9a4746d83690fe7a3fc94c6e174ecc3790b81a68c593",
                          "pinSalt": "814bb2db9c760128697fea6856bf7c25"
                        },
                        "roleSpecificData": {
                          "event_manager": {
                            "organizationId": "fYqHtUWjh58NVJJsCMan",
                            "eventId": "zcaWnsF3zTNeqZ738x2V",
                            "assignedAt": "2025-10-12T09:50:25+08:00",
                            "assignedBy": "platform_admin"
                          }
                        },
                        "activityData": {
                          "joinedAt": "2025-10-12T09:50:25+08:00",
                          "lastActiveAt": "2025-10-12T09:50:25+08:00",
                          "participationStatus": "active"
                        },
                        "accountStatus": {
                          "status": "active",
                          "createdAt": "2025-10-12T09:50:25+08:00",
                          "updatedAt": "2025-10-12T09:50:25+08:00"
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  },

  "architecture_summary": {
    "total_organizations": 2,
    "total_events": 1,
    "total_users": 5,
    "user_roles_breakdown": {
      "event_manager": 2,
      "manager": 1,
      "seller": 1,
      "merchant": 1,
      "customer": 3
    },
    "multi_role_users": 2
  },

  "path_examples": {
    "read_organization": {
      "path": "organizations/{orgId}",
      "example": "organizations/fYqHtUWjh58NVJJsCMan",
      "code": "const orgDoc = await getDoc(doc(db, 'organizations', orgId));"
    },
    "read_events_subcollection": {
      "path": "organizations/{orgId}/events",
      "example": "organizations/fYqHtUWjh58NVJJsCMan/events",
      "code": "const eventsSnapshot = await getDocs(collection(db, 'organizations', orgId, 'events'));"
    },
    "read_single_event": {
      "path": "organizations/{orgId}/events/{eventId}",
      "example": "organizations/fYqHtUWjh58NVJJsCMan/events/zcaWnsF3zTNeqZ738x2V",
      "code": "const eventDoc = await getDoc(doc(db, 'organizations', orgId, 'events', eventId));"
    },
    "read_users_subcollection": {
      "path": "organizations/{orgId}/events/{eventId}/users",
      "example": "organizations/fYqHtUWjh58NVJJsCMan/events/zcaWnsF3zTNeqZ738x2V/users",
      "code": "const usersSnapshot = await getDocs(collection(db, 'organizations', orgId, 'events', eventId, 'users'));"
    },
    "read_single_user": {
      "path": "organizations/{orgId}/events/{eventId}/users/{userId}",
      "example": "organizations/fYqHtUWjh58NVJJsCMan/events/zcaWnsF3zTNeqZ738x2V/users/phone_60123456789",
      "code": "const userDoc = await getDoc(doc(db, 'organizations', orgId, 'events', eventId, 'users', userId));"
    },
    "query_users_by_role": {
      "path": "organizations/{orgId}/events/{eventId}/users",
      "example": "Query all managers in event",
      "code": "const managersQuery = query(collection(db, 'organizations', orgId, 'events', eventId, 'users'), where('roles', 'array-contains', 'manager'));"
    }
  },

  "query_examples": {
    "get_all_event_managers": {
      "description": "获取某个活动中的所有 Event Manager",
      "code": "const managersQuery = query(\n  collection(db, 'organizations', orgId, 'events', eventId, 'users'),\n  where('roles', 'array-contains', 'event_manager')\n);\nconst snapshot = await getDocs(managersQuery);"
    },
    "get_active_users": {
      "description": "获取所有活跃用户",
      "code": "const activeUsersQuery = query(\n  collection(db, 'organizations', orgId, 'events', eventId, 'users'),\n  where('accountStatus.status', '==', 'active')\n);\nconst snapshot = await getDocs(activeUsersQuery);"
    },
    "get_customers_with_balance": {
      "description": "获取所有有余额的顾客",
      "code": "const customersQuery = query(\n  collection(db, 'organizations', orgId, 'events', eventId, 'users'),\n  where('roles', 'array-contains', 'customer'),\n  where('roleSpecificData.customer.currentBalance', '>', 0)\n);\nconst snapshot = await getDocs(customersQuery);"
    }
  },

  "security_rules_example": {
    "description": "推荐的 Firestore Security Rules",
    "rules": "rules_version = '2';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n    // Organizations collection\n    match /organizations/{orgId} {\n      allow read: if request.auth != null;\n      allow write: if request.auth.token.role == 'platform_admin';\n      \n      // Events subcollection\n      match /events/{eventId} {\n        allow read: if request.auth != null;\n        allow write: if request.auth.token.role in ['platform_admin', 'event_manager'];\n        \n        // Users subcollection\n        match /users/{userId} {\n          allow read: if request.auth != null;\n          allow write: if request.auth.token.role in ['platform_admin', 'event_manager'] || request.auth.uid == userId;\n        }\n      }\n    }\n  }\n}"
  },

  "migration_notes": {
    "before_migration": {
      "structure": "organizations/{orgId} 文档包含 events 字段对象",
      "problems": [
        "文档大小限制 1MB",
        "性能差（需要读取整个文档）",
        "无法独立设置权限",
        "不支持复杂查询",
        "并发更新容易冲突"
      ]
    },
    "after_migration": {
      "structure": "organizations/{orgId}/events/{eventId}/users/{userId} 使用子集合",
      "benefits": [
        "无文档大小限制",
        "按需加载，性能好",
        "可以为每个子集合设置独立权限",
        "支持复杂查询和索引",
        "更好的并发控制"
      ]
    },
    "what_changed": [
      "organizations/{orgId} 文档不再包含 events 字段",
      "events 现在是 subcollection: organizations/{orgId}/events",
      "events/{eventId} 文档不再包含 users 字段",
      "users 现在是 subcollection: organizations/{orgId}/events/{eventId}/users"
    ],
    "verification_checklist": [
      "✅ organizations/{orgId} 文档中没有 events 字段",
      "✅ 可以看到 events 子集合图标",
      "✅ events/{eventId} 文档中没有 users 字段",
      "✅ 可以看到 users 子集合图标",
      "✅ 所有用户数据完整",
      "✅ 用户数量一致（5个）"
    ]
  },

  "recommended_indexes": [
    {
      "collection": "organizations/{orgId}/events/{eventId}/users",
      "fields": [
        {"field": "roles", "mode": "ARRAY"},
        {"field": "accountStatus.status", "mode": "ASCENDING"}
      ],
      "description": "用于查询特定角色的活跃用户"
    },
    {
      "collection": "organizations/{orgId}/events/{eventId}/users",
      "fields": [
        {"field": "roles", "mode": "ARRAY"},
        {"field": "roleSpecificData.customer.currentBalance", "mode": "DESCENDING"}
      ],
      "description": "用于查询有余额的顾客，按余额排序"
    },
    {
      "collection": "organizations/{orgId}/events",
      "fields": [
        {"field": "status", "mode": "ASCENDING"},
        {"field": "eventInfo.fairDate", "mode": "ASCENDING"}
      ],
      "description": "用于查询特定状态的活动，按日期排序"
    }
  ]
}